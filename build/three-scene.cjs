
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("three/examples/jsm/libs/tween.module.js"),n=require("three/examples/jsm/controls/OrbitControls"),o=require("three/examples/jsm/loaders/RGBELoader.js"),r=require("three/examples/jsm/geometries/TextGeometry.js"),i=require("three/examples/jsm/lines/Line2.js"),a=require("three/examples/jsm/lines/LineMaterial.js"),s=require("three/examples/jsm/lines/LineGeometry.js"),l=require("three/examples/jsm/renderers/CSS3DRenderer.js"),c=require("three/examples/jsm/utils/BufferGeometryUtils.js"),d=require("three/examples/jsm/objects/Lensflare.js"),u=require("vue"),p=require("three/examples/jsm/loaders/FBXLoader"),m=require("three/examples/jsm/loaders/DRACOLoader"),h=require("three/examples/jsm/loaders/GLTFLoader"),f=require("three/examples/jsm/loaders/KTX2Loader"),g=require("three/examples/jsm/libs/meshopt_decoder.module"),v=require("three-cruise-path"),y=require("three/examples/jsm/renderers/CSS2DRenderer.js"),w=require("three/examples/jsm/exporters/GLTFExporter"),x=require("three/examples/jsm/loaders/GLTFLoader.js"),b=require("three/examples/jsm/loaders/DRACOLoader.js"),_=require("three/examples/jsm/loaders/FontLoader.js");function C(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var S=C(e),M=C(t),L=C(c);function P(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{l(o.next(e))}catch(e){i(e)}}function s(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const T=e=>new URL(`../src/assets/imgs/texttures/${e}`,"undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&"SCRIPT"===document.currentScript.tagName.toUpperCase()&&document.currentScript.src||new URL("three-scene.cjs",document.baseURI).href).href,z=e=>{!e&&(e="");if(!/^([hH][tT]{2}[pP]:\/\/|[hH][tT]{2}[pP][sS]:\/\/)[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}(\/\S*)?$/.test(e)){return/^(https?:\/\/)(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:[/?#]\S*)?$/.test(e)}return!0},B=(e,t="")=>Array.isArray(e)?e.map((e=>B(e,t))):!z(e)&&e.indexOf(t)<0?t+e:e,A=e=>new Promise((t=>{const n=window.indexedDB.deleteDatabase(e);console.log(n),n.onsuccess=e=>{t(!0)},n.onerror=e=>{console.log("删除失败",e),t(!1)}})),O=(e,t,n)=>new Promise((o=>{window.indexedDB.open(e).onsuccess=r=>{const i=r.target.result,a=i.version;i.close(),a!==t?A(e).then((e=>{o(e?t:a)})):i.objectStoreNames.contains(n)?o(a):A(e).then((e=>{o(e?t:a)}))}})),j=(e,...t)=>P(void 0,[e,...t],void 0,(function*(e,t="THREE__MODEL_DB",n=1){if(!window.indexedDB)return Promise.resolve(void 0);yield O(t,n,e);let o=window.indexedDB.open(t,n);return new Promise((t=>{o.onupgradeneeded=t=>{const n=t.target.result;n.objectStoreNames.contains(e)?console.log(n):n.createObjectStore(e,{keyPath:"path"})},o.onsuccess=e=>{const n=e.target.result;t(n)},o.onerror=e=>{console.log("数据库打开失败",e),t(void 0)}}))})),E=(e,t,n)=>{if(!e||!t||!n)return Promise.resolve(null);const o=e.transaction([t],"readonly").objectStore(t).get(n);return new Promise(((e,t)=>{o.onsuccess=t=>{const n=t.target.result;e(n)},o.onerror=e=>{t(e)}}))},D={TEXT:"TEXT",JSQ:"JSQ",LDB:"LDB",LQB:"LQB",XBC:"XBC",LXJ:"LXJ",LGJ:"LGJ",LGJ_2:"LGJ_2",LGJ_3:"LGJ_3",LGJ_4:"LGJ_4",LQT:"LQT",GL:"GL",BSHRQ:"BSHRQ",BSHLQ:"BSHLQ",FLRB:"FLRB",FJY_X:"FJY_X",FJZ_X:"FJZ_X",FJY:"FJY",FJZ:"FJZ",FM:"FM",XFM:"XFM"};var k={indexdb:{dbName:"THREE__MODEL__DB",tbName:"TB",version:1},mesh:{receiveShadowName:["楼板","地面","底座","底板","基础","基础底座","冷却塔基础","草地","ground","Ground"],animatehName:["动画","螺杆A","螺杆B","螺杆A001","螺杆B001","螺杆A002","螺杆B002","叶轮A","叶轮B","叶轮C","阀门"],transparentName:["透明","透明外壳"]},keys:D,rightClickBackDiffTime:300,meshKey:{body:"__BODY_",color:"__COLOR_",warning:"__WARNING_",local:"__LOCAL_",disabled:"__DISABLED_",pipe:"__PIPE__"},statusOffset:{TEXT:{[D.JSQ]:{position:{x:-20,y:10,z:0},rotation:{x:0,y:270,z:0}},[D.LDB]:{position:{x:-60,y:0,z:0}},[D.LQB]:{position:{x:0,y:0,z:60},rotation:{x:0,y:270,z:0}},[D.LXJ]:{position:{x:0,y:16,z:50},rotation:{x:-20,y:0,z:0}},[D.LGJ]:{position:{x:0,y:16,z:50},rotation:{x:-20,y:0,z:0}},[D.LQT]:{position:{x:-60,y:0,z:0}},[D.BSHLQ]:{position:{x:0,y:16,z:40}}},WARNING:{[D.JSQ]:{position:{x:0,y:62,z:0}},[D.LDB]:{position:{x:-4,y:45,z:0}},[D.LQB]:{position:{x:0,y:45,z:4},rotation:{x:0,y:270,z:0}},[D.LXJ]:{position:{x:0,y:78,z:0}},[D.LGJ]:{position:{x:0,y:78,z:0}},[D.LQT]:{position:{x:0,y:85,z:0}},[D.BSHLQ]:{position:{x:0,y:88,z:0}}},STATUS:{[D.LDB]:{position:{x:9,y:47,z:0}},[D.LQB]:{position:{x:0,y:47,z:-9},rotation:{x:0,y:270,z:0}},[D.LXJ]:{position:{x:27,y:67,z:42}},[D.LGJ]:{position:{x:-47,y:67,z:42}},[D.LQT]:{position:{x:-35,y:69,z:26}}},DISABLED:{[D.LDB]:{position:{x:22,y:47,z:0}},[D.LQB]:{position:{x:0,y:47,z:-22},rotation:{x:0,y:270,z:0}},[D.LXJ]:{position:{x:40,y:67,z:42}},[D.LGJ]:{position:{x:-34,y:67,z:42}},[D.LQT]:{position:{x:-22,y:69,z:26}}}}};const R=e=>{e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()},G=e=>{let t=e.clone();return(e.isMesh||e.isSprite)&&R(e),t.traverse((e=>{e.isMesh&&R(e)})),t},U=(e,t=6776165,n,o)=>{const{type:r,name:i}=e;r.indexOf("Light"),k.mesh.receiveShadowName.some((e=>i.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):n.some((e=>i.indexOf(e)>-1))?F(e,t):e.isMesh&&(o&&(e.material.envMap=o),e.castShadow=!0,e.receiveShadow=!0)},I=e=>{let t=[];return Array.isArray(e)?t=e:null!=e&&(t=[e]),t},F=(e,t)=>{e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t))}))},N=k.statusOffset,H=(e,t,n={})=>{const o=t.type,r=N[e]||{},i=n[o]||r[o]||{};let a=q({x:0,y:0,z:0},i.position||{}),s=q({x:0,y:0,z:0},i.rotation||{});return s.x=Math.PI/180*s.x,s.y=Math.PI/180*s.y,s.z=Math.PI/180*s.z,{position:a,rotation:s}},X=(e,t)=>Object.prototype.toString.call(t)===`[object ${e}]`,W=e=>X("Object",e),J=e=>e&&("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName),V=(e,t=new Map)=>{if(null!=e&&W(e)){let n=t.get(e);if(n)return n;const o=Array.isArray(e);let r=o?[]:{};return n=t.set(e,r),o?e.forEach(((e,t)=>{r[t]=V(e,n)})):Object.keys(e).forEach((t=>{W(r[t])?r[t]=V(e[t],n):r[t]=e[t]})),r}return e},q=(e,t)=>{e=V(e);for(let n in t)n in e&&W(t[n])&&W(e[n])?e[n]=q(e[n],t[n]):e[n]=t[n];return e},Q=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;var K=Object.freeze({__proto__:null,getTextturesUrl:T,numConverter:(e=0,t=2)=>{if(Math.abs(e)>=1e8){return 1*(e/1e8).toFixed(t)+"亿"}if(Math.abs(e)>=1e4){return 1*(e/1e4).toFixed(t)+"万"}return 1*e.toFixed(t)},getUrl:B,deleteDB:A,getDBVersion:O,createDB:j,getDataByKey:E,getAllData:(e,t)=>{const n=e.transaction(t,"readonly").objectStore(t).getAll();return new Promise(((e,t)=>{n.onsuccess=t=>{const n=t.target.result;e(n)},n.onerror=e=>{t(e)}}))},get_P_S_R_param:(e,t,n=1)=>{const o=e.position,r=e.rotation,i=e.scale,a=t.position||{x:0,y:0,z:0},s=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(s.x)<2?1:180,d=Math.abs(s.y)<2?1:180,u=Math.abs(s.z)<2?1:180;return{position:[o.x+a.x,o.y+a.y,o.z+a.z],rotation:[r.x+Math.PI/c*s.x,r.y+Math.PI/d*s.y,r.z+Math.PI/u*s.z],scale:[i.x*n*l.x,i.y*n*l.y,i.z*n*l.z]}},modelDeepClone:G,replaceMaterial:U,getColorArr:I,setMaterialColor:F,cameraInSceneAnimate:(e,t,n=new S.Vector3)=>(e.lookAt(n),e._lookAt_=n,new Promise((o=>{new M.Tween(e.position).to(t,1e3).easing(M.Easing.Quadratic.In).start().onUpdate((()=>{e.lookAt(n),e._lookAt_=n})).onComplete((()=>{o(e)}))}))),cameraLookatAnimate:(e,t,n)=>new Promise((o=>{new M.Tween(n).to(t,1e3).easing(M.Easing.Quadratic.In).start().onUpdate((t=>{e.lookAt(t),e._lookAt_=t})).onComplete((()=>{o(e)}))})),cameraLinkageControlsAnimate:(e,t,n,o)=>new Promise((r=>{new M.Tween(t.position).to(n,1e3).easing(M.Easing.Quadratic.In).start().onUpdate((()=>{const n=e.target;t.lookAt(n),t._lookAt_=n})),new M.Tween(e.target).to(o,1e3).easing(M.Easing.Quadratic.In).start().onComplete((()=>{r(t)}))})),createSpriteAnimate:(e,t,n=1,o=10)=>{let r=[0,o/2,o],i=[...t,t[0],t[1]+n,t[2],...t],a=new S.KeyframeTrack("sprite.position",r,i),s=new S.AnimationClip("sprite_up_down",o,[a]);const l=new S.AnimationMixer(e),c=l.clipAction(s);return c.timeScale=5,c.play(),e.__action__=c,e.__mixer__=l,e},getPlanePosition:(e,t,n)=>{let o=e.clientWidth/2,r=e.clientHeight/2,i=t.position.clone();const a=t.scale;i.y+=a.x/2;let s=i.project(n);return{left:s.x*o+o,top:-s.y*r+r}},findObjectsByHasProperty:(e,t,n="name")=>{let o=[];if(!e||!e.length)return[];return function e(r){r.forEach((r=>{const i=r[n];"string"==typeof i&&t.some((e=>i.indexOf(e)>-1))&&o.push(r),r.children&&e(r.children)}))}(e),o},getStatusOffset:H,createText:(e,t,n=16777215,o)=>{const i=H("TEXT",e,o);let a=e.font||{},s=new r.TextGeometry(e.name||"",{font:t,size:a.size||10,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const l=i.rotation;s.rotateX(l.x),s.rotateY(l.y),s.rotateZ(l.z);const c=i.position;s.computeBoundingBox(),s.computeVertexNormals();let d=.5*(s.boundingBox.max.x-s.boundingBox.min.x),u=.5*(s.boundingBox.max.z-s.boundingBox.min.z),p=new S.MeshPhongMaterial({color:null!=a.color?a.color:n,flatShading:!1}),m=new S.Mesh(s,p);return m.castShadow=!0,m.position.set((c.x||0)-d,c.y||0,(c.z||0)-u),m.name="text",m._isText_=!0,m},createWarning:(e,t,n,o,r=100,i=1)=>{if(!n)return;const a=H("WARNING",t,o);let s=new S.Group,l=G(n);l.scale.set(i,i,i);const c=a.position;l.position.set(c.x,c.y,c.z);const d=a.rotation;l.rotation.set(d.x,d.y,d.z),s.add(l);let u=new S.PointLight(12717056,8,r,0);u.name="灯光",u.position.y=c.y+30,s.add(u),s.name=e;let p=new S.AnimationMixer(s),m=new S.KeyframeTrack("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),h=new S.KeyframeTrack("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),f=new S.KeyframeTrack("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),g=new S.AnimationClip("warning_",1,[m,h,f]),v=p.clipAction(g);return v.paused=!0,v.play(),s.visible=!1,s._isWarning_=!0,{group:s,action:v,mixer:p}},createStatusMark:(e,t,n,o)=>{if(!t)return;const r=H(o?"DISABLED":"STATUS",e,n);let i=G(t);const a=r.position;i.position.set(a.x,a.y,a.z);const s=r.rotation;return i.rotation.set(s.x,s.y,s.z),i.visible=!1,i._isStatus_=!0,i},isType:X,isObject:W,isDOM:J,deepClone:V,deepMerge:q,checkUrl:z,random:Q}),Z={container:document.body,width:window.innerWidth,height:window.innerHeight,baseUrl:"",bgColor:null,bgUrl:null,env:null,scale:1,fog:{visible:!1,near:100,far:1e3},render:{antialias:!0,logarithmicDepthBuffer:!0,preserveDrawingBuffer:!1},controls:{visible:!0,autoRotate:!1,autoRotateSpeed:2,enableDamping:!1,dampingFactor:.25,enablePan:!0,enableRotate:!0,enableZoom:!0,maxAzimuthAngle:1/0,minAzimuthAngle:1/0,minDistance:1,maxDistance:2e3,minPolarAngle:0,maxPolarAngle:Math.PI,maxTargetRadius:1/0,rotateSpeed:1,screenSpacePanning:!0},ambientLight:{visible:!0,color:16777215,intensity:1.5},directionalLight:{visible:!0,helper:!1,position:[500,1e3,800],position2:[-500,800,-800],light2:!0,color:16777215,intensity:1.5},camera:{helper:!1,near:1,far:1e4,position:[-350,510,700]},cruise:{visible:!1,enabled:!1,runing:!1,helper:!1,points:[],segment:2,tension:0,baseUrl:"",repeat:[.1,1],width:15,speed:1,mapSpeed:.006,offset:10,factor:1,auto:!1,animateBack:void 0,alway:!1},grid:{visible:!1,opacity:.3,transparent:!0,width:800,divisions:80,centerLineColor:10592673,gridColor:10592673,fork:!1,forkSize:1.4,forkColor:10592673},axes:{visible:!1,size:50}};const Y=()=>({initCSS3DRender:(e,t)=>{const{width:n,height:o}=e,r=new l.CSS3DRenderer;return r.setSize(n,o),r.domElement.style.position="absolute",r.domElement.style.left="0px",r.domElement.style.top="0px",r.domElement.style.pointerEvents="none",t.appendChild(r.domElement),r},createCSS3DDom:e=>{const{name:t,className:n="",onClick:o,position:r,sprite:i}=e,a=document.createElement("div");a.innerHTML=t,a.className=n;const s=i?new l.CSS3DSprite(a):new l.CSS3DObject(a);return a.style.pointerEvents=o?"auto":"none",a.style.position="absolute","function"==typeof o&&a.addEventListener("click",o),r&&s.position.set(...r),s}}),{createCSS3DDom:$}=Y(),ee=()=>({visible:!0,enabled:!1,runing:!1,helper:!1,points:[],segment:2,close:!0,tension:0,baseUrl:"",mapUrl:T("arrow.png"),repeat:[.1,1],width:15,speed:1,mapSpeed:.006,offset:10,factor:1,index:0,auto:!1,tube:!1,color:16777215,radius:1,radialSegments:1,animateBack:void 0,alway:!1}),te=()=>{let e,t,n,o=ee();const r=(t,r)=>{n=new S.Mesh(new S.SphereGeometry(2),new S.MeshBasicMaterial({color:0,opacity:.8,depthTest:!1,transparent:!0})),t.add(n);const i=(new S.BufferGeometry).setFromPoints(r.concat(r[0])),a=new S.LineBasicMaterial({color:255,opacity:1,depthTest:!1,transparent:!0}),s=new S.Line(i,a);t.add(s);const l=new S.TubeGeometry(e,100,o.width/2,3,!0),c=new S.MeshLambertMaterial({color:16711935,opacity:.1,depthTest:!1,transparent:!0}),d=new S.Mesh(l,c),u=new S.MeshBasicMaterial({color:16715760,opacity:.3,wireframe:!0,depthTest:!1,transparent:!0}),p=new S.Mesh(l,u);d.add(p),t.add(d)},i=()=>{var e;return 900*(null!==(e=o.segment)&&void 0!==e?e:2)},a=()=>null==e?void 0:e.getPoints(i()),s=(e,t)=>new S.Vector3(t.x,t.y+e,t.z),l=e=>{if(!o.enabled)return;switch(e.keyCode){case 38:case 87:o.runing?(o.factor*=1.5,o.factor>10&&(o.factor=10)):o.index+=5;break;case 83:case 40:o.runing||(o.index-=5,o.index<0&&(o.index=i()))}},c=e=>{if(!o.enabled)return;o.factor=1;switch(e.keyCode){case 32:o.runing=!o.runing;break;case 38:case 87:o.runing||(o.index+=10);break;case 83:case 40:o.runing||(o.index-=10,o.index<0&&(o.index=i()))}};return{createCruise:(n,i)=>{o=q(ee(),n);const{points:s,tension:l,mapUrl:c,baseUrl:d,repeat:u,width:p,helper:m,close:h,tube:f,color:g,radius:y,radialSegments:w}=o,x=[];for(let e=0;e<s.length;e++){const t=s[e];x.push(new S.Vector3(t[0],t[1],t[2]))}e=new S.CatmullRomCurve3(x,h,"catmullrom",null!=l?l:0),e=new S.CatmullRomCurve3(a(),h,"catmullrom",null!=l?l:0);const b=new S.Group;t=(new S.TextureLoader).load(B(c,d),(e=>{e.wrapS=S.RepeatWrapping,e.repeat.x=u[0],e.repeat.y=u[1],e.anisotropy=i.capabilities.getMaxAnisotropy()}));const _=new S.MeshPhongMaterial({color:g,map:t,opacity:.9,transparent:!0,depthTest:!0,side:S.FrontSide}),C=new S.Vector3(0,1,0),M=new v.PathPointList;M.set(a(),y,w,C,!1);const L=f?new v.PathTubeGeometry:new v.PathGeometry;L.update(M,f?{radius:y,radialSegments:w,progress:1,startRad:0}:{width:p,arrow:!1,progress:1,side:"both"},!1);const P=new S.Mesh(L,_);return b.add(P),b.name="cruise",m&&r(b,x),b.renderOrder=99,b},updateCruise:e=>{o=q(o,e)},cruiseAnimate:r=>{if(!r)return;if(!e)return;const{mapSpeed:a,speed:l,factor:c,enabled:d,runing:u,offset:p,helper:m,auto:h,animateBack:f}=o;if(t&&(t.offset.x-=a),!(h||u&&d))return;(h||u&&d)&&(o.index+=c*l);const g=i(),v=o.index%g/g;let y=v+.001;y>1&&(y-=1);const w=e.getPointAt(y);if(m&&n){const e=s(p,w);n.position.copy(e)}const x=s(p,e.getPointAt(v));if(!h||u&&d){r.position.copy(x);const e=s(p,w);r._lookAt_=e,r.lookAt(e)}"function"==typeof f&&f(x,w,e,v)},bindEvent:()=>{window.addEventListener("keydown",l,!1),window.addEventListener("keyup",c,!1)},removeEvent:()=>{window.removeEventListener("keyup",c),window.removeEventListener("keydown",l)}}},ne=()=>({createFork:(e={})=>{const{width:t=800,divisions:n=80,forkSize:o=1.4,forkColor:r=10592673}=e;let i=t/n,a=-t/2;const s=new S.Group;for(let e=0;e<=n;e++)for(let t=0;t<=n;t++){const n=a+e*i,l=a+t*i,c=new S.PlaneGeometry(o,o/5),d=new S.MeshLambertMaterial({color:r,transparent:!0,opacity:.9}),u=new S.Mesh(c,d);u.rotateX(.5*-Math.PI),u.position.set(n,0,l);const p=u.clone();p.rotateZ(.5*Math.PI),s.add(u,p)}return s}}),oe=["216","217","218","219","220","221","222","223","224","225","226"];var re,ie,ae=Object.freeze({__proto__:null,useConvertData:()=>({transformGeoJSON:e=>{let t=e.features;for(let e=0;e<t.length;e++){const n=t[e];"Polygon"===n.geometry.type&&(n.geometry.coordinates=[n.geometry.coordinates])}return e}}),useCountryLine:()=>{const e=(e,t,n="LineLoop")=>{let o;if("Line2"===n){const n=new s.LineGeometry;n.setPositions(e),o=new i.Line2(n,t),o.name="countryLine2",o.computeLineDistances()}else{const r=new S.BufferGeometry;r.setFromPoints(e),o=new S[n](r,t),o.name="countryLine"}return o};return{createCountryFlatLine:(t,n,o="LineLoop")=>{let r={color:65535,linewidth:1,depthTest:!1};r=q(r,n);let i=new S.LineBasicMaterial(r);"Line2"===o&&(i=new a.LineMaterial(r));let s=t.features,l=new S.Group;for(let t=0;t<s.length;t++){const n=s[t].geometry.coordinates;for(let t=0;t<n.length;t++){const r=n[t],a=[];"Line2"===o?r.forEach((e=>{e.forEach((e=>{a.push(e[0],0,-e[1])}))})):r.forEach((e=>{e.forEach((e=>{a.push(new S.Vector3(e[0],e[1],0))}))}));let s=e(a,i,o);l.add(s)}}return l},getPoints:(e,t=0,n)=>{let o=e.features;const r=[];for(let e=0;e<o.length;e++){const i=o[e].geometry.coordinates;for(let e=0;e<i.length;e++)i[e].forEach((e=>{e.forEach((e=>{n?r.push(new S.Vector3(e[0],t,-e[1])):r.push(e[0],t,-e[1])}))}))}return r}}},useMapBar:(e={})=>{let t=q({height:10,size:2,factor:1,color1:1048575,color2:16777215},e);return{createBar:(e={},n={})=>{var o;t=q(t,n);let{size:r,height:i,factor:a,color1:s,color2:l}=t;r*=a,i*=a,i*=null!==(o=e.heightRatio)&&void 0!==o?o:a;const[c,d,u]=e.position||[0,0,0],p=new S.Group,m=new S.BoxGeometry(r,r,i),h=new S.ShaderMaterial({depthTest:!1,transparent:!0,vertexColors:!1,uniforms:{uColor1:{value:new S.Color(s)},uColor2:{value:new S.Color(l)},uOpacity:{value:.6}},vertexShader:"\n\t\t\t\tvarying vec3 vColor;\n\t\t\t\tuniform vec3 uColor1;\n\t\t\t\tuniform vec3 uColor2;\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat percent = (position.z + 0.0) / 100.0; // 计算当前像素点在立方体高度上的百分比\n\t\t\t\t\tvColor = mix(uColor1.rgb, uColor2.rgb, percent);\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tvarying vec3 vColor;\n\t\t\t\tuniform float uOpacity;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = vec4(vColor, uOpacity);\n\t\t\t\t}\n\t\t\t"}),f=new S.Mesh(m,h);if(p.add(f),p.name="柱状图",p.position.set(c,d,u+i/2),p.renderOrder=99,e.label){const{name:t="",className:n="",onClick:o}=e.label,r=$({name:t,className:n,position:[0,0,i/2],onClick:o});r.rotateX(.5*Math.PI),p.add(r)}return p}}},useOutline:(e={})=>{let t=q({size:.1,color:16085360,range:500,factor:1,speed:6},e);const n=e=>{const n=e.material,o=n.uniforms.uLength.value;n.uniforms.uIndex.value+=t.speed,n.uniforms.uIndex.value>=o&&(n.uniforms.uIndex.value=0)};return{createOutline:(e,n={})=>{t=q(t,n);const{size:o,factor:r,range:i,color:a}=t,s=new Float32Array(e),l=new S.BufferGeometry;l.setAttribute("position",new S.BufferAttribute(s,3));const c=new Float32Array(Math.floor(s.length/3)).map(((e,t)=>t));l.setAttribute("aIndex",new S.BufferAttribute(c,1));const d=new S.ShaderMaterial({vertexShader:"\n\t\t\t\tattribute float aOpacity;\n\t\t\t\tuniform float uSize;\n\n\t\t\t\tattribute float aIndex;\n\t\t\t\tvarying vec3 vp;\n\t\t\t\tvarying float vertexIndex;\n\n\t\t\t\tvoid main(){\n\t\t\t\t\tgl_Position = projectionMatrix*modelViewMatrix*vec4(position,1.0);\n\t\t\t\t\tgl_PointSize = uSize;\n\n\t\t\t\t\tvp = position;\n\t\t\t\t\tvertexIndex = aIndex;\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tvarying float vertexIndex;\n\t\t\t\tuniform vec3 uColor;\n\t\t\t\tuniform float uIndex;\n\t\t\t\tuniform float uRange;\n\n\t\t\t\tfloat invert(float n){\n\t\t\t\t\treturn 1.-n;\n\t\t\t\t}\n\n\t\t\t\tvoid main(){\n\t\t\t\t\tfloat uOpacity = 1.0;\n\t\t\t\t\tif(vertexIndex <= uIndex || vertexIndex >= (uRange + uIndex)){\n\t\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}\n\t\t\t\t\tuOpacity = (vertexIndex - uIndex)/uRange;\n\t\t\t\t\tif ( uOpacity < 0.2) {\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}\n\t\t\t\t\tvec2 uv=vec2(gl_PointCoord.x,invert(gl_PointCoord.y));\n\t\t\t\t\tvec2 cUv=2.*uv-1.;\n\t\t\t\t\tvec4 color=vec4(1./length(cUv));\n\t\t\t\t\tcolor*=uOpacity;\n\t\t\t\t\tcolor.rgb*=uColor;\n\t\t\t\t\tgl_FragColor=color;\n\t\t\t\t}\n\t\t\t",transparent:!0,depthTest:!1,uniforms:{uSize:{value:o*r},uIndex:{value:0},uLength:{value:c.length},uRange:{value:i},uColor:{value:new S.Color(a)}}}),u=new S.Points(l,d);return u.name="轮廓",u.scale.setScalar(r),u},update:n,outlineUpdate:n}},useMarkLight:(e={})=>{let t=q({pointTextureUrl:T("point.png"),circleTextureUrl:T("circle.png"),lightTextureUrl:T("light.png"),factor:1,color:65535},e);const n=new S.TextureLoader;return{createMarkLight:(e=[0,0,0],o=10,r={})=>{t=q(t,r);const i=new S.Group,a=new S.PlaneGeometry(o/6.219,o);a.rotateX(-Math.PI/2),a.translate(0,0,o/2);const s=new S.MeshBasicMaterial({map:n.load(t.lightTextureUrl),color:t.color,transparent:!0,depthWrite:!1,side:S.DoubleSide});let l=new S.Mesh(a,s);l.rotateX(Math.PI),l.position.z=o,l.renderOrder=3,l.name="光柱 01";let c=l.clone();c.name="光柱 02",c.rotateZ(Math.PI/2);const d=(()=>{const e=new S.PlaneGeometry(3,3),o=new S.MeshBasicMaterial({map:n.load(t.pointTextureUrl),color:t.color,side:S.DoubleSide,transparent:!0,depthWrite:!1});let r=new S.Mesh(e,o);r.renderOrder=1,r.name="底部光点";const i=.3*t.factor;return r.scale.setScalar(i),r})(),u=(()=>{const e=new S.PlaneGeometry(3,3),o=new S.MeshBasicMaterial({map:n.load(t.circleTextureUrl),color:t.color,side:S.DoubleSide,opacity:0,transparent:!0,depthWrite:!1});let r=new S.Mesh(e,o);r.renderOrder=2,r.name="createLightHalo";const i=.5*t.factor;r.scale.setScalar(i);const a=Q(0,2e3);return r.tween1=new M.Tween({scale:i,opacity:0}).to({scale:1.5*i,opacity:1},1e3).delay(a).onUpdate((e=>{let{scale:t,opacity:n}=e;r.scale.setScalar(t),r.material.opacity=n})),r.tween2=new M.Tween({scale:1.5*i,opacity:1}).to({scale:2*i,opacity:0},1e3).onUpdate((e=>{let{scale:t,opacity:n}=e;r.scale.setScalar(t),r.material.opacity=n})),r.tween1.chain(r.tween2),r.tween2.chain(r.tween1),r.tween1.start(),r})();i.add(l,c,d,u);const[p,m,h]=e;return i.position.set(p,m,h),i.rotateX(.5*Math.PI),i.name="光柱标记",i}}},useFence:()=>{const e=[1,.8],t=.2,n=(new S.TextureLoader).load(T("fenceMap0.png"),(n=>{n.wrapT=S.RepeatWrapping,n.repeat.x=e[0],n.repeat.y=e[1],n.offset.y=t})),o=(new S.TextureLoader).load(T("fenceMap1.png"),(n=>{n.wrapT=S.RepeatWrapping,n.repeat.x=e[0],n.repeat.y=e[1],n.offset.x=t})),r=(new S.TextureLoader).load(T("fenceMap2.png"),(e=>{e.wrapS=S.RepeatWrapping,e.wrapT=S.RepeatWrapping})),i=(e,t,i)=>{const a=[];for(let n=0;n<t.length;n++){const o=t[n];a.push(...e[o])}const s=new S.BufferGeometry,l=new Float32Array(a);s.setAttribute("position",new S.BufferAttribute(l,3));const c=t.length,d=new S.BufferAttribute(new Float32Array(3*c),3);s.setAttribute("normal",d);for(let e=0;e<c;e++)d.setXYZ(e,0,0,0);const u=new S.BufferAttribute(new Float32Array([1,1,0,1,0,0,0,0,1,0,1,1]),2);s.setAttribute("uv",u);const p=new S.MeshPhongMaterial({color:i,map:n,transparent:!0,blending:S.AdditiveBlending,side:S.DoubleSide}),m=new S.MeshPhongMaterial({color:i,map:o,transparent:!0,blending:S.AdditiveBlending,side:S.DoubleSide});var h=new S.MeshPhongMaterial({color:i,map:r,opacity:.5,transparent:!0,side:S.DoubleSide});const f=new S.Mesh(s,p),g=new S.Group,v=new S.Mesh(s,m),y=new S.Mesh(s,h);return g.add(f,v,y),g};return{createFence:(e,t=11009923)=>{const n=new S.Group;var o=new S.BoxHelper(e,t);o.update();const r=o.geometry.getAttribute("position").array,a=[];for(let e=0;e<r.length;e+=3){const t=r[e],n=r[e+1],o=r[e+2];a.push([t,n,o])}const s=i(a,[0,1,2,2,3,0],t),l=i(a,[4,5,6,6,7,4],t),c=i(a,[4,0,3,3,7,4],t),d=i(a,[1,5,6,6,2,1],t);return n.add(s,l,c,d),n},fenceAnimate:(e=1)=>{const r=.008*e;if(n){let e=n.offset.y-r;e<0&&(e=t),n.offset.y=e}if(o){let e=o.offset.y-r;e<0&&(e=t),o.offset.y=e}}}},useCorrugatedPlate:(e={})=>{let t=q({range:100,interval:.8,size:.2,color:47273,light:881527,factor:1},e);const n=(e,t)=>{const n=e.material,o=n.uniforms.uRange.value,r=n.uniforms.uLength.value;n.uniforms.uRadius.value+=t*(o/4),n.uniforms.uRadius.value>=o+r&&(n.uniforms.uRadius.value=0)};return{createCorrugatedPlate:(e={})=>{t=q(t,e);let{range:n,color:o,light:r,factor:i}=t;n*=i;const a=(()=>{let{range:e,interval:n,size:o,factor:r}=t;e*=r,n*=r,o*=r;const i=[],a=Math.floor(e/n);for(let e=-a;e<=a;e++)for(let t=-a;t<=a;t++){const r=new S.PlaneGeometry(o,o),a=e*n,s=t*n,l=new S.Matrix4,c=new S.Vector3(a,-o,s),d=new S.Quaternion,u=new S.Euler,p=new S.Vector3(1,1,1);d.setFromEuler(u),l.compose(c,d,p),r.applyMatrix4(l),i.push(r)}return i})(),s=L.mergeGeometries(a),l=new S.ShaderMaterial({uniforms:{uColor:{value:new S.Color(r)},uTcolor:{value:new S.Color(o)},uRadius:{value:1.25},uLength:{value:n/10},uRange:{value:n}},vertexShader:"\n\t\t\t\tvarying vec3 vp;\n\t\t\t\tvoid main(){\n\t\t\t\t\tvp = position;\n\t\t\t\t\tgl_Position\t= projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tvarying vec3 vp;\n\t\t\t\tuniform vec3 uColor;\n\t\t\t\tuniform vec3 uTcolor;\n\t\t\t\tuniform float uRadius;\n\t\t\t\tuniform float uLength;\n\t\t\t\tfloat getLeng(float x, float y){\n\t\t\t\t\treturn\tsqrt((x-0.0)*(x-0.0)+(y-0.0)*(y-0.0));\n\t\t\t\t}\n\t\t\t\tvoid main(){\n\t\t\t\t\tfloat uOpacity = 0.8;\n\t\t\t\t\tvec3 vColor = uColor;\n\t\t\t\t\tfloat length = getLeng(vp.x,vp.z);\n\t\t\t\t\tif ( length <= uRadius && length > uRadius - uLength ) {\n\t\t\t\t\t\tfloat op = sin( (uRadius - length) / uLength ) ;\n\t\t\t\t\t\tuOpacity = op;\n\t\t\t\t\t\tif ( vp.y < 0.0 ) {\n\t\t\t\t\t\t\tvColor = uColor * op;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvColor = uTcolor;\n\t\t\t\t\t\t};\n\t\t\t\t\t\tvColor = uTcolor;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(vColor,uOpacity);\n\t\t\t\t}\n\t\t\t",transparent:!0,depthWrite:!1,side:S.DoubleSide}),c=new S.Mesh(s,l);return c.name="波纹板",c},update:n,corrugatedPlateUpdate:n}},useDiffusion:()=>{let e;return{createDiffusion:(t=10,n=16715760,o=5)=>{const r=new S.PlaneGeometry(t,t,1,1),i=["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(""),a=["varying vec2 vUv;","uniform vec3 uColor;","uniform float uOpacity;","uniform float uSpeed;","uniform float uSge;","uniform float time;","float PI = 3.14159265;","float drawCircle(float index, float range) {","\tfloat opacity = 1.0;","\tif (index >= 1.0 - range) {","\t\topacity = 1.0 - (index - (1.0 - range)) / range;","\t} else if(index <= range) {","\t\topacity = index / range;","\t}","\treturn opacity;","}","float distanceTo(vec2 src, vec2 dst) {","\tfloat dx = src.x - dst.x;","\tfloat dy = src.y - dst.y;","\tfloat dv = dx * dx + dy * dy;","\treturn sqrt(dv);","}","void main() {","\tfloat iTime = -time * uSpeed;","\tfloat opacity = 0.0;","\tfloat len = distanceTo(vec2(0.5, 0.5), vec2(vUv.x, vUv.y));","\tfloat size = 1.0 / uSge;","\tvec2 range = vec2(0.65, 0.75);","\tfloat index = mod(iTime + len, size);","\tvec2 cRadius = vec2(0.06, 0.12);","\tif (index < size && len <= 0.5) {","\t\tfloat i = sin(index / size * PI);","\t\tif (i >= range.x && i <= range.y){","\t\t\tfloat t = (i - range.x) / (range.y - range.x);","\t\t\tfloat r = 0.3;","\t\t\topacity = drawCircle(t, r);","\t\t}","\t\topacity *=\t1.0 - len / 0.5;","\t};","\tgl_FragColor = vec4(uColor, uOpacity * opacity);","}"].join("");e=new S.ShaderMaterial({uniforms:{uColor:{value:new S.Color(n)},uOpacity:{value:1},uSpeed:{value:.1},uSge:{value:o},uRadius:{value:t/2},time:{value:0}},transparent:!0,vertexShader:i,fragmentShader:a,depthTest:!1,blending:S.AdditiveBlending,side:S.DoubleSide});return new S.Mesh(r,e)},updateDiffusion:(t=1)=>{if(!e)return;const n=.001*performance.now()*t;e.uniforms.time.value=n}}},useFlywire:(e={})=>{let t,n,o=q({depth:0,height:4,divisions:1e3,color:16777215,flyColor:16761095,pointColor:16715760,pointWidth:2.5,flyPointWidth:2.4,tubularSegments:256,radius:.5,radialSegments:8,closed:!1,length:100,factor:1,speed:4},e);const r=e=>{const[t,r]=e;let{pointWidth:i,depth:a,factor:s}=o;const l=i*s;a*=s;const c=new S.PlaneGeometry(l,l,1,1),d=new S.Mesh(c,n);return d.position.set(t,a,-r),d.rotateX(.5*-Math.PI),d},i=(e={})=>{o=q(o,e),t=new S.ShaderMaterial({depthTest:!1,uniforms:{uColor:{value:new S.Color(o.flyColor)},uIndex:{value:0},uTotal:{value:o.divisions},uWidth:{value:o.flyPointWidth},uLength:{value:o.length}},vertexShader:["attribute float aIndex;","uniform float uIndex;","uniform float uWidth;","uniform vec3 uColor;","varying float vSize;","uniform float uLength;","void main(){","\t\tvec4 viewPosition = viewMatrix * modelMatrix * vec4(position,1);","\t\tgl_Position = projectionMatrix * viewPosition;","\t\tif(aIndex >= uIndex - uLength && aIndex < uIndex){","\t\t\tvSize = uWidth * ((aIndex - uIndex + uLength) / uLength);","\t\t}","\t\tgl_PointSize = vSize;","}"].join(""),side:S.DoubleSide,fragmentShader:["varying float vSize;","uniform vec3 uColor;","void main(){","\t\tif(vSize<=0.0){","\t\t\tgl_FragColor = vec4(1,0,0,0);","\t\t}else{","\t\t\tgl_FragColor = vec4(uColor,1);","\t\t}","}"].join(""),transparent:!0,vertexColors:!1}),n=new S.ShaderMaterial({uniforms:{uColor:{value:new S.Color(o.pointColor)},uOpacity:{value:1},uSpeed:{value:.1},uSge:{value:4},uRadius:{value:o.pointWidth*o.factor/2},time:{value:0}},transparent:!0,depthTest:!1,vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(""),fragmentShader:["varying vec2 vUv;","uniform vec3 uColor;","uniform float uOpacity;","uniform float uSpeed;","uniform float uSge;","uniform float time;","float PI = 3.14159265;","float drawCircle(float index, float range) {","\tfloat opacity = 1.0;","\tif (index >= 1.0 - range) {","\t\topacity = 1.0 - (index - (1.0 - range)) / range;","\t} else if(index <= range) {","\t\topacity = index / range;","\t}","\treturn opacity;","}","float distanceTo(vec2 src, vec2 dst) {","\tfloat dx = src.x - dst.x;","\tfloat dy = src.y - dst.y;","\tfloat dv = dx * dx + dy * dy;","\treturn sqrt(dv);","}","void main() {","\tfloat iTime = -time * uSpeed;","\tfloat opacity = 0.0;","\tfloat len = distanceTo(vec2(0.5, 0.5), vec2(vUv.x, vUv.y));","\tfloat size = 1.0 / uSge;","\tvec2 range = vec2(0.65, 0.75);","\tfloat index = mod(iTime + len, size);","\tvec2 cRadius = vec2(0.06, 0.12);","\tif (index < size && len <= 0.5) {","\t\tfloat i = sin(index / size * PI);","\t\tif (i >= range.x && i <= range.y){","\t\t\t// 归一","\t\t\tfloat t = (i - range.x) / (range.y - range.x);","\t\t\tfloat r = 0.3;","\t\t\topacity = drawCircle(t, r);","\t\t}","\t\topacity *=\t1.0 - len / 0.5;","\t};","\tgl_FragColor = vec4(uColor, uOpacity * opacity);","}"].join("\n"),side:S.DoubleSide})},a=()=>{const e=t,r=e.uniforms.uTotal.value;e.uniforms.uIndex.value+=o.speed,e.uniforms.uIndex.value>=r&&(e.uniforms.uIndex.value=0);const i=.001*performance.now();n.uniforms.time.value=i};return i(),{createFlywireTexture:i,createFlywire:e=>{const n=new S.Group,i=r(e[0]),a=r(e[1]);n.add(i,a);const s=(e=>{const[t,n]=e[0],[r,i]=e[1];let{depth:a,height:s,factor:l,divisions:c}=o;s=(a+s)*l,a*=l;const d=new S.Vector3(t,a,-n),u=new S.Vector3(t+(r-t)/4,s,-(n+(i-n)/4)),p=new S.Vector3(t+3*(r-t)/4,s,-(n+3*(i-n)/4)),m=new S.Vector3(r,a,-i);return new S.CubicBezierCurve3(d,u,p,m).getPoints(c)})(e),l=new S.CatmullRomCurve3(s,!1,"centripetal",.5),c=new S.TubeGeometry(l,o.tubularSegments,o.radius,o.radialSegments,o.closed),d=new S.ShaderMaterial({transparent:!0,opacity:1,depthTest:!1,vertexColors:!1,uniforms:{uColor:{value:new S.Color(o.color)},uOpacity:{value:.6}},vertexShader:["varying vec3 vColor;","uniform vec3 uColor;","void main() {","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join(""),fragmentShader:["uniform vec3 uColor;","uniform float uOpacity;","void main() {","\tgl_FragColor = vec4(uColor, uOpacity);","}"].join("")}),u=new S.Mesh(c,d);u.renderOrder=10;const p=(e=>{const n=new Float32Array(e.map(((e,t)=>t))),o=(new S.BufferGeometry).setFromPoints(e);return o.setAttribute("aIndex",new S.BufferAttribute(n,1)),new S.Points(o,t)})(s);return n.add(u,p),n},update:a,flywireUpdate:a}},useLensflare:(e={})=>{let t=q({mainTextureUrl:T("lensflare0.png"),minorTextureUrl:T("lensflare3.png")},e);const n=new S.TextureLoader,o=n.load(t.mainTextureUrl),r=n.load(t.minorTextureUrl);return{addLensflare:(e,t,n,i)=>{const a=new S.PointLight(16777215,1,2e3,0);a.color.set(e),a.position.set(t,n,i);const s=new d.Lensflare;return s.addElement(new d.LensflareElement(o,700,0,a.color)),s.addElement(new d.LensflareElement(r,60,.6)),s.addElement(new d.LensflareElement(r,70,.7)),s.addElement(new d.LensflareElement(r,120,.9)),s.addElement(new d.LensflareElement(r,70,1)),a.add(s),a}}},useFileLoader:()=>{const e=u.ref(0);return{load:t=>{const n=new S.FileLoader;return new Promise(((o,r)=>{n.load(t,(e=>{let t={};try{t=JSON.parse(e)}catch(e){}o(t)}),(t=>{let{loaded:n,total:o}=t;e.value=Number((n/o*100).toFixed(0))}),r)}))},progress:e}},useUpload:e=>{const t=q({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/"},e);return{uploadModel:(e,n,o)=>{const{baseUrl:r,dracoPath:i,basisPath:a}=t,s=e[0],l=s.name,c=l.split(".").pop().toLowerCase(),d=new FileReader;d.addEventListener("progress",(e=>{const t="("+Math.floor(e.total/1e3)+" KB)",n=Math.floor(e.loaded/e.total*100)+"%";o&&o({progress:n,filename:l,size:t})})),d.addEventListener("load",(e=>P(void 0,void 0,void 0,(function*(){const t=e.target.result;if(["glb","gltf"].includes(c)){const e=new h.GLTFLoader,o=new m.DRACOLoader;o.setDecoderPath(`${r}${i}`),e.setDRACOLoader(o);const s=new f.KTX2Loader;s.setTranscoderPath(`${r}${a}`),e.setKTX2Loader(s),e.setMeshoptDecoder(g.MeshoptDecoder),e.parse(t,"",(t=>{var o,r,i;const a=t.scene.children;let s=new S.Group;a.length>1?s.add(...a):s=a[a.length-1],s.name=(null===(o=s.userData)||void 0===o?void 0:o.name)||l,s.animations.push(...t.animations),n(s),null===(r=e.dracoLoader)||void 0===r||r.dispose(),null===(i=e.ktx2Loader)||void 0===i||i.dispose()}))}else if("fbx"==c){const e=(new p.FBXLoader).parse(t,"");n(e)}})))),d.readAsArrayBuffer(s)}}},useCollide:()=>{const e=new S.Raycaster,t=new S.Vector3(0,2,0);return{checkCollide:(n,o,r,i=!0,a=t)=>{const s=o.clone().add(a),l=new S.Vector3;n.getWorldDirection(l),l.normalize(),e.ray.origin.copy(s),e.ray.direction.copy(l);return e.intersectObjects(r,i)}}},useCoord:()=>({getBoundingBox:e=>{var t=new S.Box3;t.expandByObject(e);var n=new S.Vector3;t.getSize(n);var o=new S.Vector3;return t.getCenter(o),{box3:t,center:o,size:n}}}),useRaycaster:()=>{const e=new S.Raycaster,t=new S.Vector2,n={left:0,top:0};return{raycaster:e,pointer:t,style:n,update:(e,o,r=1)=>{const i=o.getBoundingClientRect()||{left:0,top:0};t.x=(e.clientX-i.left)/(o.clientWidth*r)*2-1,t.y=-(e.clientY-i.top)/(o.clientHeight*r)*2+1;const a=o.clientWidth/2,s=o.clientHeight/2;n.left=t.x*a+a,n.top=-t.y*s+s}}},useCruise:te,useCSS2D:()=>({initCSS2DRender:(e,t)=>{const{width:n,height:o}=e,r=new y.CSS2DRenderer;return r.setSize(n,o),r.domElement.style.position="absolute",r.domElement.style.left="0px",r.domElement.style.top="0px",r.domElement.style.pointerEvents="none",t.appendChild(r.domElement),r},createCSS2DDom:e=>{const{name:t,className:n="",onClick:o,position:r}=e,i=document.createElement("div");i.innerHTML=t,i.className=n;const a=new y.CSS2DObject(i);return i.style.pointerEvents=o?"auto":"none",i.style.position="absolute","function"==typeof o&&i.addEventListener("click",(e=>o(e,a))),r&&a.position.set(...r),a}}),CSS2DRenderer:y.CSS2DRenderer,useCSS3D:Y,CSS3DRenderer:l.CSS3DRenderer,useFloor:(e={})=>{const t=q({mode:"BA",margin:50},e),n=(e,t,n,o)=>{0!==t.length&&t.forEach((t=>{var r,i,a,s;const l=t._position_,c="UD"==e?(null!==(r=l.y)&&void 0!==r?r:0)+n:null!==(i=l.y)&&void 0!==i?i:0,d="BA"==e?(null!==(a=l.z)&&void 0!==a?a:0)+o:null!==(s=l.z)&&void 0!==s?s:0;new M.Tween(t.position).to({y:c,z:d},500).easing(M.Easing.Quadratic.Out).start()}))};return{floorAnimate:(e,o,r)=>{var i,a,s,l,c,d;const u=void 0!==o&&o>-1,{margin:p,mode:m}=t;for(let t=0;t<e.length;t++){const h=e[t],f=h._position_;const g=(t-(u?o:t))*p;let v=(null!==(i=f.y)&&void 0!==i?i:0)+g,y=o==t?(null!==(a=f.z)&&void 0!==a?a:0)+p:null!==(s=f.z)&&void 0!==s?s:0;const w=o===t&&("UD"===m&&v===h.position.y||"BA"===m&&y===h.position.z);if(w&&(v=null!==(l=f.y)&&void 0!==l?l:0,y=null!==(c=f.z)&&void 0!==c?c:0),"UD"===m){if(h.position.y===v)continue}else if("BA"===m&&h.position.z===y)continue;if(null===(d=h.data)||void 0===d?void 0:d.mark){const e=r(h.data.mark);let i=o==t?p:0;w&&(i=0),n(m,e,g,i)}new M.Tween(h.position).to({y:"UD"===m?v:h.position.y,z:"BA"===m?y:h.position.z},500).easing(M.Easing.Quadratic.Out).start()}}}},useDialog:(e={})=>{const t=u.reactive(q({show:!1,style:{left:"",top:""},select:[],data:{},title:"",position:{top:0,left:0}},e));return{dialog:t,options:t,show:u.toRef(t.show)}},useGrid:ne,useMaterial:()=>{const e=(e,t=.5)=>{const n=e=>{e.material.transparent=!0,e.material.opacity=t};e.isMesh?n(e):e.traverse((e=>{e.isMesh&&n(e)}))},t=e=>({color:e.color,map:e.map,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,emissiveMap:e.emissiveMap,bumpMap:e.bumpMap,normalMap:e.normalMap,displacementMap:e.displacementMap,opacity:e.opacity,transparent:e.transparent,side:e.side}),n=(e,o,r)=>{if(e instanceof Array){let t=e.map((e=>n(e,o,r)));e=t}else o?(e.metalness=.5,e.roughness=0):(e.metalness=.5,e.roughness=1),e=new S.MeshStandardMaterial(Object.assign(Object.assign({},t(e)),{metalness:e.metalness,roughness:e.roughness,side:r?S.DoubleSide:S.FrontSide}));return e},o=(e,t)=>{const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),n.href=URL.createObjectURL(e),n.download=t,n.click(),n.remove()};return{materialReplace:(t,o,r,i=1211922)=>{const a=k.mesh,s=a.animatehName,l=a.transparentName,{type:c,name:d}=r;if(c.indexOf("Light")>-1){if(!r.shadow)return;let e=800;if(r.castShadow=!0,r.shadow.camera.right=e,r.shadow.camera.left=-e,r.shadow.camera.top=e,r.shadow.camera.bottom=-e,"SpotLight"===c){let e=new S.SpotLightHelper(r,r.color);t.add(e)}else if("PointLight"===c){let e=new S.PointLightHelper(r,r.color);t.add(e)}}else{if(!o.transformMaterial||!r.isMesh)return r.castShadow=!0,void(r.receiveShadow=!0);if(o.opacitySkin&&l.find((e=>d.indexOf(e)>-1))&&e(r,o.opacity),a.receiveShadowName.find((e=>d.indexOf(e)>-1))){r.receiveShadow=!0;const e=o.groundReflection;r.material=n(r.material,e,o.side)}else if(s.find((e=>d.indexOf(e)>-1))){let e=new S.MeshStandardMaterial({color:i,metalness:.6,roughness:.6});r.material=e}else r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0,r.material=n(r.material,o.glisten,o.side))}},changeTransparent:e,exportGlb:(e,t,n,r=!0)=>{if(!e)return;const i={binary:r,animations:t};(new w.GLTFExporter).parse(e,(e=>{if(e instanceof ArrayBuffer)t=n+".glb",o(new Blob([e],{type:"application/octet-stream"}),t);else{((e,t)=>{o(new Blob([e],{type:"text/plain"}),t)})(JSON.stringify(e,null,2),n+".gltf")}var t}),(e=>{console.log("An error happened during parsing",e)}),i)},getAnimations:e=>{const t=[];e.traverse((e=>{t.push(...e.animations)}));const n=[];for(const e of t)n.push(e.clone().optimize());return n},setMetalnessMaterial:(e={color:16777215},n,o)=>new S.MeshStandardMaterial(Object.assign(Object.assign({},t(e)),{metalness:n,roughness:o})),setGlassMaterial:(e={color:16777215},{metalness:n=0,roughness:o=0,envMapIntensity:r=0,transmission:i=0,ior:a=0})=>new S.MeshPhysicalMaterial(Object.assign(Object.assign({},t(e)),{metalness:n,roughness:o,envMapIntensity:r,transmission:i,ior:a})),centerBoxHelper:(e,t=16711680)=>{var n=new S.BoxHelper(e,t);n.update();return{helper:n,center:(new S.Box3).setFromObject(e).getCenter(new S.Vector3)}}}},useMoveAnimate:()=>{let e;const t={index:0,length:0,runing:!1,model:void 0,speed:1,endCallback:void 0,rungingCall:void 0},n=t=>null==e?void 0:e.getPoints(t),o=(n=!0)=>{if(t.runing=!1,n){const n=t.index-1;t.model.position.copy((n=>{let o=n/t.length;return o>1?o=1:o<0&&(o=0),e.getPointAt(o)})(n))}};return{createMove:(o,r,i,a)=>{const s=o.position,l=Math.atan2(-r.z+s.z,r.x-s.x);o.rotation.y=.5*Math.PI+l;const c=s.distanceTo(r);let d=Math.floor(c/t.speed);d<2&&(d=2);const u=[s,r];e=new S.CatmullRomCurve3(u,!1,"catmullrom",0),e=new S.CatmullRomCurve3(n(d),!1,"catmullrom",0),t.model=o,t.index=0,t.length=d,t.rungingCall=i,t.endCallback=a,t.runing=!0},moveAnimate:(n=1)=>{if(!t.runing)return;t.index+=n;let r=t.index/t.length;r>1&&(r=1);const i=e.getPointAt(r);t.model.position.copy(i),r>=1?(t.runing=!1,"function"==typeof t.endCallback&&t.endCallback(i)):"function"==typeof t.rungingCall&&t.rungingCall(i,o)}}},useRoam:()=>{let e,t={runing:!1,segment:2,close:!0,tension:0,offset:0,points:[],factor:1,speed:1,index:0,animateBack:void 0};const n=(n={})=>{if(e)return;t=q({runing:!1,segment:2,close:!0,tension:0,offset:0,points:[],factor:1,speed:1,index:0,animateBack:void 0},n);const{points:r,tension:i,close:a}=t,s=[];for(let e=0;e<r.length;e++){const t=r[e];s.push(new S.Vector3(t[0],t[1],t[2]))}e=new S.CatmullRomCurve3(s,a,"catmullrom",null!=i?i:0),e=new S.CatmullRomCurve3(o(),a,"catmullrom",null!=i?i:0)},o=()=>null==e?void 0:e.getPoints(r()),r=()=>{var e;return 1e3*(null!==(e=t.segment)&&void 0!==e?e:2)},i=(e,t)=>new S.Vector3(t.x,t.y+e,t.z);return{createRoam:n,updateRoam:e=>{t=q(t,e)},executeRoam:(n,o)=>{if(!n||!o)return;if(!e)return;const{runing:a,offset:s,factor:l,speed:c,animateBack:d}=t;if(!a)return;t.index+=l*c;const u=r(),p=t.index%u/u;let m=p+.01;m>1&&(m-=1);const h=e.getPointAt(m),f=i(s,e.getPointAt(p)),g=i(s,h);o.target=g,n._lookAt_=g,n.lookAt(o.target),"function"==typeof d&&d(f,h,e,p)},pause:()=>{t.runing=!1},play:()=>{t.runing=!0},reset:t=>{e=void 0,n(t)},getStatus:()=>t.runing}},useOpenTheDoor:()=>{let e={propertyName:"name",value:"",scale:10,axle:"z",isOpen:void 0,leftMatch:"左",rightMatch:"右",duration:1e3,angle:.5*Math.PI,autoClose:!0,delay:1e4};const t=(n,o)=>{const{propertyName:r,value:i,scale:a,axle:s,isOpen:l,leftMatch:c,rightMatch:d,duration:u,autoClose:p,delay:m}=q(e,o),h=n.getObjectByProperty(r,i);if(!h)return console.warn("未找到目标！"),Promise.reject();const f=h.children.find((e=>e.name.indexOf(c)>-1)),g=h.children.find((e=>e.name.indexOf(d)>-1));if(!f||!g)return console.warn("未找到双开门！"),Promise.reject();p&&clearTimeout(h.__timer__);const v=f.position,y=g.position;return null==h.__open__&&(f.__position__=(new S.Vector3).copy(v),g.__position__=(new S.Vector3).copy(y)),h.__open__=void 0!==l?l:!h.__open__,new Promise((e=>{const r=g.__position__[s]+(h.__open__?-a:0);if(y[s]===r)return e(h);new M.Tween(v).to({[s]:f.__position__[s]+(h.__open__?a:0)},u).delay(0).start(),new M.Tween(y).to({[s]:r},u).delay(0).start().onComplete((()=>{e(h)})),p&&h.__open__&&(h.__timer__=setTimeout((()=>{t(n,o)}),m+u))}))},n=(t,o)=>{const{propertyName:r,value:i,angle:a,axle:s,isOpen:l,duration:c,autoClose:d,delay:u}=q(e,o),p=t.getObjectByProperty(r,i);if(!p)return console.warn("未找到目标！"),Promise.reject();d&&clearTimeout(p.__timer__);const m=p.rotation;return null==p.__open__&&(p.__rotation__=(new S.Euler).copy(m)),p.__open__=void 0!==l?l:!p.__open__,new Promise((e=>{const r=p.__rotation__[s]+(p.__open__?-a:0);if(m[s]===r)return e(p);new M.Tween(p.rotation).to({[s]:r},c).delay(0).start(),d&&p.__open__&&(p.__timer__=setTimeout((()=>{n(t,o)}),u+c))}))},o=(t,n)=>{const{propertyName:r,value:i,angle:a,axle:s,leftMatch:l,rightMatch:c,isOpen:d,duration:u,autoClose:p,delay:m}=q(e,n),h=t.getObjectByProperty(r,i);if(!h)return console.warn("未找到目标！"),Promise.reject();const f=h.children.find((e=>e.name.indexOf(l)>-1)),g=h.children.find((e=>e.name.indexOf(c)>-1));if(!f||!g)return console.warn("未找到双开门！"),Promise.reject();p&&clearTimeout(h.__timer__);const v=f.rotation,y=g.rotation;return null==h.__open__&&(f.__rotation__=(new S.Euler).copy(v),g.__rotation__=(new S.Euler).copy(y)),h.__open__=void 0!==d?d:!h.__open__,new Promise((e=>{const r=g.__rotation__[s]+(h.__open__?-a:0);if(y[s]===r)return e(h);new M.Tween(f.rotation).to({[s]:f.__rotation__[s]+(h.__open__?a:0)},u).delay(0).start(),new M.Tween(g.rotation).to({[s]:r},u).delay(0).start(),p&&h.__open__&&(h.__timer__=setTimeout((()=>{o(t,n)}),m+u))}))};return{dubleHorizontal:t,oddRotate:n,dubleRotate:o}},useKeyboardState:()=>{const e=["shift","ctrl","alt","meta"],t={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,tab:9},n={},o={};let r,i;const a=(e,t)=>{var r=e.keyCode;n[r]=t,o.shift=e.shiftKey,o.ctrl=e.ctrlKey,o.alt=e.altKey,o.meta=e.metaKey},s=e=>{a(e,!0),"function"==typeof r&&r(e)},l=e=>{a(e,!1),"function"==typeof i&&i(e)};document.addEventListener("keydown",s,!1),document.addEventListener("keyup",l,!1);const c=r=>{for(var i=r.split("+"),a=0;a<i.length;a++){var s=i[a];if(!(-1!==e.indexOf(s)?o[s]:-1!=Object.keys(t).indexOf(s)?n[t[s]]:n[s.toUpperCase().charCodeAt(0)]))return!1}return!0};return{keyboardPressed:e=>Array.isArray(e)?e.findIndex(c)>-1:c(e),insertEvent:(e,t)=>{r=e,i=t},destroyEvent:()=>{document.removeEventListener("keydown",s,!1),document.removeEventListener("keyup",l,!1)}}},useBackground:e=>{const t=oe.findIndex((t=>t==e)),n=u.ref(t<0?0:t),o=e=>{const t=oe[n.value];t&&(i(e,t),n.value++,n.value>=oe.length&&(n.value=0))},r=e=>["posX.jpeg","negX.jpeg","posY.jpeg","negY.jpeg","posZ.jpeg","negZ.jpeg"].map((t=>((e,t)=>new URL(`../src/assets/imgs/sky/${e}/${t}`,"undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&"SCRIPT"===document.currentScript.tagName.toUpperCase()&&document.currentScript.src||new URL("three-scene.cjs",document.baseURI).href).href)(e,t))),i=(e,t)=>{const n=r(t);if("function"==typeof e.setBgTexture)e.setBgTexture(n);else if(Array.isArray(n)){const t=(new S.CubeTextureLoader).load(n);e.background=t}else e.background=(new S.TextureLoader).load(n)};return{skys:oe,index:n,change:o,changeBackground:o,load:i,getBgGroup:r,backgroundLoad:i}},useModelLoader:(e={})=>{let t;const n=q({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},e),o=u.reactive({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),r={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},i=new Map,a=new b.DRACOLoader;a.setDecoderPath(n.baseUrl+n.dracoPath);const s=new x.GLTFLoader;s.setDRACOLoader(a);const l=new f.KTX2Loader;l.setTranscoderPath(n.baseUrl+n.basisPath),s.setKTX2Loader(l),s.setMeshoptDecoder(g.MeshoptDecoder);const c=e=>{const t=e.loaded,n=o.total;let r=Number((t+o.loaded)/n*100);r>100&&(r=100),o.percentage=Number(r.toFixed(2))},d=(e,t,o,r)=>{if(!o)return;const{baseUrl:a,colorMeshName:s}=n,{mapUrl:l,key:c,mapMeshName:d,repeat:u=[1,1]}=e;let p;l&&d&&(p=(new S.TextureLoader).load(B(l,a)),p.wrapS=S.RepeatWrapping,p.wrapT=S.RepeatWrapping,p.repeat.set(u[0],u[1]));const m=G(o);return m.traverse((e=>{e.isMesh&&p&&e.name.indexOf(d)>-1?e.material=new S.MeshLambertMaterial({side:S.DoubleSide,transparent:!0,opacity:0,map:p.clone()}):U(e,t,s||[])})),l&&d&&(m._mapMeshName_=d),m.animations=r,c&&i.set(c,m),m},p=(e,o=0)=>new Promise((r=>P(void 0,void 0,void 0,(function*(){var i;n.indexDB.cache||r(null);const a=S.Cache.get(e);if(a)a instanceof ArrayBuffer?(c({loaded:a.byteLength}),s.parse(a,"",(t=>{S.Cache.add(e,t),r(t)}))):(c({loaded:o*n.modelSizeKB}),setTimeout((()=>{r(a)}),10));else{const o=yield E(t,(null===(i=n.indexDB)||void 0===i?void 0:i.tbName)||k.indexdb.tbName,e);if(o&&o.data){const e=o.data;"string"==typeof e?(c({loaded:e.length}),S.Cache.add(o.path,e),setTimeout((()=>{r(e)}),10)):(c({loaded:e.byteLength}),s.parse(e,"",(e=>{S.Cache.add(o.path,e),r(e)})))}else r(null)}})))),m=e=>{var o;if(!n.indexDB.cache)return;const r=S.Cache.get(e);if(r&&t){const i=(null===(o=n.indexDB)||void 0===o?void 0:o.tbName)||k.indexdb.tbName;t.transaction(i,"readwrite").objectStore(i).add({path:e,data:r})}},h=(e,t)=>{const{key:o,url:r="",size:i=0}=e,{baseUrl:a,colors:l}=n;return new Promise(((n,u)=>P(void 0,void 0,void 0,(function*(){let h=l.normal[o]||l.normal.color;h=I(h)[0];const f=B(r,a),g=yield p(f,i);if(g){const t=g.scene.children[0],o=d(e,h,t,g.animations);return void n(o)}let v=(f.split(".").pop()||"").toLowerCase();if("glb"!==v)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+v);s.load(f,(t=>{const o=t.scene.children;let r=new S.Group;o.length>1?r.add(...o):r=o[o.length-1];const i=d(e,h,r,t.animations);m(f),n(i)}),(e=>{c(e),"function"==typeof t&&t(e)}),u)}))))},v=(e,t={})=>{t=q({color:57599,wireframe:!0,opacity:.5,filter:[],filterMatch:[]},t),e.traverse((e=>{var n;(null===(n=t.filter)||void 0===n?void 0:n.includes(e.name))||y(e.name,t.filterMatch)||e.isMesh&&(e.__material__||(e.__material__=e.material),e.material=new S.MeshBasicMaterial({color:t.color,wireframe:t.wireframe,transparent:!0,opacity:t.opacity}))}))},y=(e="",t=[])=>t.filter((t=>e.indexOf(t)>-1)).length>0;return{progress:o,MODEL_MAP:r,loadModel:h,loadModels:(e,a,s)=>P(void 0,void 0,void 0,(function*(){var l,d,u;yield j((null===(l=n.indexDB)||void 0===l?void 0:l.tbName)||k.indexdb.tbName,(null===(d=n.indexDB)||void 0===d?void 0:d.dbName)||k.indexdb.dbName,(null===(u=n.indexDB)||void 0===u?void 0:u.version)||k.indexdb.version).then((e=>(e&&(S.Cache.enabled=!0,t=e),e)));const f=e.length;if(!(0==f?(o.isEnd=!0,o.show=!1,0):(o.isEnd=!1,o.percentage=0,o.show=!0,1)))return;(e=>{for(let t=0;t<e.length;t++)o.total+=(e[t].size||0)*n.modelSizeKB})(e);let g=0;const v=()=>P(void 0,void 0,void 0,(function*(){const t=e[g],{type:l=r.device,size:d=0}=t;switch(l){case r.device:case r.pipe:yield h(t,s);break;case r.sprite:(e=>{const{key:t,range:o={x:1,y:1},mapUrl:r=""}=e;let a=(new S.TextureLoader).load(n.baseUrl+r),s=new S.SpriteMaterial({map:a}),l=new S.Sprite(s),c=o.x,d=o.y;l.scale.set(c,d,1),l.name="sprite",i.set(t,l)})(t);break;case r.font:yield((e,t)=>{const{url:o="",size:a=0}=e,{baseUrl:s}=n,l=B(o,s),d=new _.FontLoader;return new Promise(((e,n)=>P(void 0,void 0,void 0,(function*(){const o=yield p(l,a);if(o){const t=d.parse(JSON.parse(o));return i.set(r.font,t),void setTimeout((()=>{e(t)}),10)}d.load(l,(t=>{i.set(r.font,t),m(l),e(t)}),(e=>{c(e),"function"==typeof t&&t(e)}),n)}))))})(t,s);break;case r.warning:t.key=r.warning,yield h(t,s);break;case r.local:t.key=r.local,yield h(t,s);break;case r.disabled:t.key=r.disabled,yield h(t,s);break;case r.spotlight:(e=>{const{key:t,color:n=16777215,intensity:o=8,distance:r=10,angle:a=.2*Math.PI,penumbra:s=.2,decay:l=0}=e;let c=new S.SpotLight(n,o,r,a,s,l);c.castShadow=!0,c.visible=!1,i.set(t,c)})(t)}g++,o.loaded+=d*n.modelSizeKB,g>=f?(o.percentage=100,o.isEnd=!0,a()):v()}));v()})),getModel:e=>i.get(e),virtualization:(e=[],t,n={})=>{const o=n.filter||[],r=n.filterMatch||[];if(e.length)for(let i=0;i<e.length;i++){const a=e[i];t.uuid===a.uuid||o.includes(a.name)||y(a.name,r)||v(a,n)}else v(t,n)},closeVirtualization:e=>{if(Array.isArray(e))for(let t=0;t<e.length;t++)e[t].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}}});const{createCruise:se,cruiseAnimate:le,updateCruise:ce,bindEvent:de,removeEvent:ue}=te(),{createFork:pe}=ne();class me{constructor(e={}){re.add(this);const t=Z;this.options=q(t,e),me.total++,this.pointer={tsp:0,isClick:!1},J(this.options.container)?this.container=this.options.container:this.container=document.querySelector(this.options.container),this.options.width=this.container.offsetWidth,this.options.height=this.container.offsetHeight,this.scene=new S.Scene,this.renderer=this.initRenderer(),this.baseCamera=this.initCamera(),this.controls=this.initControls(),this.init(),this.initCruise(),console.log(this)}get camera(){const{visible:e,runing:t,auto:n}=this.options.cruise;return e&&this.cruiseCamera&&t?this.cruiseCamera:this.baseCamera}init(){this.initLight(),this.initGrid(),this.initAxes(),this.initModel()}run(){this.loop()}loop(){this.animationId=window.requestAnimationFrame((()=>{this.loop()})),this.animate(),this.modelAnimate()}animate(){var e;this.renderer&&this.renderer.render(this.scene,this.camera),this.options.controls.visible&&(null===(e=this.controls)||void 0===e||e.update()),le(this.cruiseCamera),M.update()}initModel(){}modelAnimate(){}initRenderer(){const{width:e,height:t,bgColor:n,bgUrl:o,env:r}=this.options,i=new S.WebGLRenderer(this.options.render);if(r&&this.setEnvironment(r),o?this.setBgTexture(o):this.setBgColor(n),this.options.fog.visible){const{color:e,near:t,far:n}=this.options.fog;this.scene.fog=new S.Fog(null!=e?e:this.scene.background,t,n)}return i.sortObjects=!0,i.shadowMap.enabled=!0,i.shadowMap.type=S.PCFSoftShadowMap,i.setSize(e,t),i.setPixelRatio(window.devicePixelRatio),this.container.appendChild(i.domElement),i}initLight(){const{ambientLight:e,directionalLight:t}=this.options;if(e.visible){const t=new S.AmbientLight(e.color,e.intensity);this.addObject(t)}if(t.visible){const e=this.createDirectionalLight(),[n=0,o=0,r=0]=t.position;if(e.position.set(n,o,r),this.addObject(e),t.helper){const t=new S.DirectionalLightHelper(e,1);this.addObject(t)}if(t.light2){const e=this.createDirectionalLight(!1),[n=0,o=0,r=0]=t.position2;if(e.position.set(n,o,r),this.addObject(e),t.helper){const t=new S.DirectionalLightHelper(e,1);this.addObject(t)}}}}createDirectionalLight(e=!0,t=2e3,n=4096,o=1,r=2e4){const{color:i,intensity:a}=this.options.directionalLight,s=new S.DirectionalLight(i,a);if(e){s.shadow.mapSize.setScalar(n),s.shadow.bias=-1e-5,s.shadow.normalBias=.01,s.castShadow=e;const i=s.shadow.camera;i.near=o,i.far=r,i.top=i.right=t,i.left=i.bottom=-t,i.updateProjectionMatrix()}return s}initCamera(){const{width:e,height:t,camera:n}=this.options;let o=new S.PerspectiveCamera(36,e/t,n.near,n.far);if(n.orthogonal){let r=e/t,i=260;o=new S.OrthographicCamera(-i*r,i*r,i,-i,n.near,n.far)}if(o.position.set(...n.position),o.lookAt(0,0,0),n.helper){const e=new S.CameraHelper(o);this.addObject(e)}return o}initControls(){const e=this.options.controls;if(!e.visible)return;const t=new n.OrbitControls(this.camera,this.renderer.domElement);return Object.keys(e).forEach((n=>{t[n]=e[n]})),t.target.set(0,0,0),t.saveState(),t}initCruise(){const{visible:e}=this.options.cruise;e&&(this.cruiseCamera=this.initCamera(),function(e,t,n,o){if("a"===n&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?o:"a"===n?o.call(e):o?o.value:t.get(e)}(this,re,"m",ie).call(this))}initGrid(){const e=this.options.grid;if(!e.visible)return;const{width:t,divisions:n,centerLineColor:o,gridColor:r,opacity:i,transparent:a,fork:s}=e,l=new S.GridHelper(t,n,o,r);if(l.material.opacity=i,l.material.transparent=a,this.grid=l,this.addObject(l),s){const t=pe(e);t.name="辅助交叉点",t._isGridFork_=!0,this.addObject(t)}}initAxes(){if(!this.options.axes.visible)return;const e=new S.AxesHelper(this.options.axes.size);this.addObject(e)}createGround(e=5e3,t,n=11721691){t=void 0===t?e:t;const o=new S.PlaneGeometry(e,t),r=new S.MeshPhongMaterial({color:n,shininess:10}),i=new S.Mesh(o,r);return i.name="ground",i.rotation.x=1.5*Math.PI,i.receiveShadow=!0,i}createClock(){this.clock=new S.Clock}setCruisePoint(e){this.options.cruise.points=e,this.createCruise()}createCruise(){const{visible:e,points:t,alway:n}=this.options.cruise;if(!e)return;if(this.cruiseGroup&&this.disposeObj(this.cruiseGroup),de(),!t||0==t.length)return;const o=se(this.options.cruise,this.renderer);this.cruiseGroup=o,o.visible=n,this.addObject(o)}toggleCruise(e){let{visible:t,runing:n,auto:o,alway:r}=this.options.cruise;t&&(n=null!=e?e:n,this.options.cruise.runing=!n,this.options.cruise.enabled=!n,this.controls&&(this.controls.enabled=o||n),this.cruiseGroup&&!r&&(this.cruiseGroup.visible=!n),ce(this.options.cruise))}toggleCruiseDepthTest(e){this.cruiseGroup&&this.cruiseGroup.traverse((t=>{(t.isMesh||t.isLine)&&(t.material.depthTest=null!=e?e:!t.material.depthTest)}))}setScale(e){this.options.scale=e}setEnvironment(e){(new o.RGBELoader).load(B(e,this.options.baseUrl),(e=>{e.mapping=S.EquirectangularReflectionMapping,this.scene.environment=e}))}setBgTexture(e){if(Array.isArray(e)){const t=(new S.CubeTextureLoader).load(B(e,this.options.baseUrl));this.scene.background=t}else this.scene.background=(new S.TextureLoader).load(B(e))}setBgColor(e){this.scene.background=e?new S.Color(e):null}bindEvent(){const e=this.renderer.domElement;e.addEventListener("dblclick",this.onDblclick.bind(this)),e.addEventListener("pointerdown",this.onPointerDown.bind(this)),e.addEventListener("pointermove",this.onPointerMove.bind(this)),e.addEventListener("pointerup",this.onPointerUp.bind(this))}onDblclick(e){}onPointerDown(e){this.pointer.isClick=!0,this.pointer.tsp=e.timeStamp}onPointerMove(e){}onPointerUp(e){this.pointer.isClick=!1}exportImage(){const e=document.createElement("a");e.download="render.png",e.href=this.renderer.domElement.toDataURL().replace("image/png","image/octet-stream"),e.click()}getPosition(){var e,t;return console.log("camera.position",this.camera.position),console.log("controls.target",null===(e=this.controls)||void 0===e?void 0:e.target),{position:this.camera.position,target:null===(t=this.controls)||void 0===t?void 0:t.target}}isCameraMove(e,t=1){const n=this.camera.position;return Math.abs(n.x-e.x)<t&&Math.abs(n.y-e.y)<t&&Math.abs(n.z-e.z)<t}addObject(...e){this.scene.add(...e)}controlSave(){var e;null===(e=this.controls)||void 0===e||e.saveState()}controlReset(){var e;null===(e=this.controls)||void 0===e||e.reset(),this.toggleCruise(!0)}getValidTargetPosition(e,t,n,o={x:-104,y:7,z:58}){const r=t||e.to||o,i=n||e.target||{x:0,y:0,z:0},a=this.controls;return a&&a.target&&a.target.set(i.x,i.y,i.z),r}resize(){this.options.width=this.container.offsetWidth||window.innerWidth,this.options.height=this.container.offsetHeight||window.innerHeight;const{width:e,height:t,camera:n}=this.options,o=e/t;n.orthogonal||(this.baseCamera.aspect=o),this.baseCamera.updateProjectionMatrix(),this.cruiseCamera&&(n.orthogonal||(this.cruiseCamera.aspect=o),this.cruiseCamera.updateProjectionMatrix()),this.renderer.setSize(e,t)}stopAnimate(){window.cancelAnimationFrame(this.animationId)}clear(e){e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())}disposeObj(e){e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear(),this.scene.remove(e))}dispose(){var e;ue(),this.stopAnimate();try{S.Cache.clear(),this.disposeObj(this.scene),this.scene.clear(),this.renderer.dispose(),this.renderer.forceContextLoss();let t=this.renderer.domElement.getContext("webgl");t&&(null===(e=t.getExtension("WEBGL_lose_context"))||void 0===e||e.loseContext()),this.disposeObj(this.cruiseGroup),this.disposeObj(this.grid),this.controls&&this.controls.dispose(),this.scene=void 0,this.renderer=void 0,this.baseCamera=void 0,this.cruiseCamera=void 0,this.controls=void 0,this.grid=void 0,this.cruiseGroup=void 0,this.container.innerHTML=""}catch(e){console.log(e)}}}re=new WeakSet,ie=function(){const e=this.options.cruise;e.enabled=!1,e.runing=!1,e.baseUrl&&(e.baseUrl=this.options.baseUrl),e.factor=1},me.total=0,exports.Hooks=ae,exports.Scene=me,exports.Utils=K;
