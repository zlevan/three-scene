
import*as e from"three";import*as t from"three/examples/jsm/libs/tween.module.js";import{OrbitControls as o}from"three/examples/jsm/controls/OrbitControls";import{RGBELoader as n}from"three/examples/jsm/loaders/RGBELoader.js";import{TextGeometry as r}from"three/examples/jsm/geometries/TextGeometry.js";import{Line2 as i}from"three/examples/jsm/lines/Line2.js";import{LineMaterial as a}from"three/examples/jsm/lines/LineMaterial.js";import{LineGeometry as s}from"three/examples/jsm/lines/LineGeometry.js";import{CSS3DRenderer as l,CSS3DSprite as c,CSS3DObject as d}from"three/examples/jsm/renderers/CSS3DRenderer.js";import*as u from"three/examples/jsm/utils/BufferGeometryUtils.js";import{Lensflare as p,LensflareElement as m}from"three/examples/jsm/objects/Lensflare.js";import{ref as h,reactive as f,toRef as g}from"vue";import{FBXLoader as v}from"three/examples/jsm/loaders/FBXLoader";import{DRACOLoader as w}from"three/examples/jsm/loaders/DRACOLoader";import{GLTFLoader as y}from"three/examples/jsm/loaders/GLTFLoader";import{KTX2Loader as x}from"three/examples/jsm/loaders/KTX2Loader";import{MeshoptDecoder as b}from"three/examples/jsm/libs/meshopt_decoder.module";import{PathPointList as C,PathTubeGeometry as M,PathGeometry as S}from"three-cruise-path";import{CSS2DRenderer as L,CSS2DObject as z}from"three/examples/jsm/renderers/CSS2DRenderer.js";import{GLTFExporter as P}from"three/examples/jsm/exporters/GLTFExporter";import{GLTFLoader as _}from"three/examples/jsm/loaders/GLTFLoader.js";import{DRACOLoader as B}from"three/examples/jsm/loaders/DRACOLoader.js";import{FontLoader as A}from"three/examples/jsm/loaders/FontLoader.js";function T(e,t,o,n){return new(o||(o=Promise))((function(r,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}l((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const k=e=>new URL(`../assets/imgs/texttures/${e}`,import.meta.url).href,j=e=>{!e&&(e="");if(!/^([hH][tT]{2}[pP]:\/\/|[hH][tT]{2}[pP][sS]:\/\/)[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}(\/\S*)?$/.test(e)){return/^(https?:\/\/)(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:[/?#]\S*)?$/.test(e)}return!0},E=(e,t="")=>Array.isArray(e)?e.map((e=>E(e,t))):!j(e)&&e.indexOf(t)<0?t+e:e,D=e=>new Promise((t=>{const o=window.indexedDB.deleteDatabase(e);console.log(o),o.onsuccess=e=>{t(!0)},o.onerror=e=>{console.log("删除失败",e),t(!1)}})),O=(e,t,o)=>new Promise((n=>{window.indexedDB.open(e).onsuccess=r=>{const i=r.target.result,a=i.version;i.close(),a!==t?D(e).then((e=>{n(e?t:a)})):i.objectStoreNames.contains(o)?n(a):D(e).then((e=>{n(e?t:a)}))}})),R=(e,...t)=>T(void 0,[e,...t],void 0,(function*(e,t="THREE__MODEL_DB",o=1){if(!window.indexedDB)return Promise.resolve(void 0);yield O(t,o,e);let n=window.indexedDB.open(t,o);return new Promise((t=>{n.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains(e)?console.log(o):o.createObjectStore(e,{keyPath:"path"})},n.onsuccess=e=>{const o=e.target.result;t(o)},n.onerror=e=>{console.log("数据库打开失败",e),t(void 0)}}))})),G=(e,t,o)=>{if(!e||!t||!o)return Promise.resolve(null);const n=e.transaction([t],"readonly").objectStore(t).get(o);return new Promise(((e,t)=>{n.onsuccess=t=>{const o=t.target.result;e(o)},n.onerror=e=>{t(e)}}))},U={TEXT:"TEXT",JSQ:"JSQ",LDB:"LDB",LQB:"LQB",XBC:"XBC",LXJ:"LXJ",LGJ:"LGJ",LGJ_2:"LGJ_2",LGJ_3:"LGJ_3",LGJ_4:"LGJ_4",LQT:"LQT",GL:"GL",BSHRQ:"BSHRQ",BSHLQ:"BSHLQ",FLRB:"FLRB",FJY_X:"FJY_X",FJZ_X:"FJZ_X",FJY:"FJY",FJZ:"FJZ",FM:"FM",XFM:"XFM"};var I={indexdb:{dbName:"THREE__MODEL__DB",tbName:"TB",version:1},mesh:{receiveShadowName:["楼板","地面","底座","底板","基础","基础底座","冷却塔基础","草地","ground","Ground"],animatehName:["动画","螺杆A","螺杆B","螺杆A001","螺杆B001","螺杆A002","螺杆B002","叶轮A","叶轮B","叶轮C","阀门"],transparentName:["透明","透明外壳"]},keys:U,rightClickBackDiffTime:300,meshKey:{body:"__BODY_",color:"__COLOR_",warning:"__WARNING_",local:"__LOCAL_",disabled:"__DISABLED_",pipe:"__PIPE__"},statusOffset:{TEXT:{[U.JSQ]:{position:{x:-20,y:10,z:0},rotation:{x:0,y:270,z:0}},[U.LDB]:{position:{x:-60,y:0,z:0}},[U.LQB]:{position:{x:0,y:0,z:60},rotation:{x:0,y:270,z:0}},[U.LXJ]:{position:{x:0,y:16,z:50},rotation:{x:-20,y:0,z:0}},[U.LGJ]:{position:{x:0,y:16,z:50},rotation:{x:-20,y:0,z:0}},[U.LQT]:{position:{x:-60,y:0,z:0}},[U.BSHLQ]:{position:{x:0,y:16,z:40}}},WARNING:{[U.JSQ]:{position:{x:0,y:62,z:0}},[U.LDB]:{position:{x:-4,y:45,z:0}},[U.LQB]:{position:{x:0,y:45,z:4},rotation:{x:0,y:270,z:0}},[U.LXJ]:{position:{x:0,y:78,z:0}},[U.LGJ]:{position:{x:0,y:78,z:0}},[U.LQT]:{position:{x:0,y:85,z:0}},[U.BSHLQ]:{position:{x:0,y:88,z:0}}},STATUS:{[U.LDB]:{position:{x:9,y:47,z:0}},[U.LQB]:{position:{x:0,y:47,z:-9},rotation:{x:0,y:270,z:0}},[U.LXJ]:{position:{x:27,y:67,z:42}},[U.LGJ]:{position:{x:-47,y:67,z:42}},[U.LQT]:{position:{x:-35,y:69,z:26}}},DISABLED:{[U.LDB]:{position:{x:22,y:47,z:0}},[U.LQB]:{position:{x:0,y:47,z:-22},rotation:{x:0,y:270,z:0}},[U.LXJ]:{position:{x:40,y:67,z:42}},[U.LGJ]:{position:{x:-34,y:67,z:42}},[U.LQT]:{position:{x:-22,y:69,z:26}}}}};const F=e=>{e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()},N=e=>{let t=e.clone();return(e.isMesh||e.isSprite)&&F(e),t.traverse((e=>{e.isMesh&&F(e)})),t},W=(e,t=6776165,o,n)=>{const{type:r,name:i}=e;r.indexOf("Light"),I.mesh.receiveShadowName.some((e=>i.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):o.some((e=>i.indexOf(e)>-1))?J(e,t):e.isMesh&&(n&&(e.material.envMap=n),e.castShadow=!0,e.receiveShadow=!0)},H=e=>{let t=[];return Array.isArray(e)?t=e:null!=e&&(t=[e]),t},J=(e,t)=>{e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t))}))},X=I.statusOffset,V=(e,t,o={})=>{const n=t.type,r=X[e]||{},i=o[n]||r[n]||{};let a=$({x:0,y:0,z:0},i.position||{}),s=$({x:0,y:0,z:0},i.rotation||{});return s.x=Math.PI/180*s.x,s.y=Math.PI/180*s.y,s.z=Math.PI/180*s.z,{position:a,rotation:s}},Q=(e,t)=>Object.prototype.toString.call(t)===`[object ${e}]`,K=e=>Q("Object",e),Z=e=>e&&("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName),Y=(e,t=new Map)=>{if(null!=e&&K(e)){let o=t.get(e);if(o)return o;const n=Array.isArray(e);let r=n?[]:{};return o=t.set(e,r),n?e.forEach(((e,t)=>{r[t]=Y(e,o)})):Object.keys(e).forEach((t=>{K(r[t])?r[t]=Y(e[t],o):r[t]=e[t]})),r}return e},$=(e,t)=>{e=Y(e);for(let o in t)o in e&&K(t[o])&&K(e[o])?e[o]=$(e[o],t[o]):e[o]=t[o];return e},q=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;var ee=Object.freeze({__proto__:null,getTextturesUrl:k,numConverter:(e=0,t=2)=>{if(Math.abs(e)>=1e8){return 1*(e/1e8).toFixed(t)+"亿"}if(Math.abs(e)>=1e4){return 1*(e/1e4).toFixed(t)+"万"}return 1*e.toFixed(t)},getUrl:E,deleteDB:D,getDBVersion:O,createDB:R,getDataByKey:G,getAllData:(e,t)=>{const o=e.transaction(t,"readonly").objectStore(t).getAll();return new Promise(((e,t)=>{o.onsuccess=t=>{const o=t.target.result;e(o)},o.onerror=e=>{t(e)}}))},get_P_S_R_param:(e,t,o=1)=>{const n=e.position,r=e.rotation,i=e.scale,a=t.position||{x:0,y:0,z:0},s=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(s.x)<2?1:180,d=Math.abs(s.y)<2?1:180,u=Math.abs(s.z)<2?1:180;return{position:[n.x+a.x,n.y+a.y,n.z+a.z],rotation:[r.x+Math.PI/c*s.x,r.y+Math.PI/d*s.y,r.z+Math.PI/u*s.z],scale:[i.x*o*l.x,i.y*o*l.y,i.z*o*l.z]}},modelDeepClone:N,replaceMaterial:W,getColorArr:H,setMaterialColor:J,cameraInSceneAnimate:(o,n,r=new e.Vector3)=>(o.lookAt(r),o._lookAt_=r,new Promise((e=>{new t.Tween(o.position).to(n,1e3).easing(t.Easing.Quadratic.In).start().onUpdate((()=>{o.lookAt(r),o._lookAt_=r})).onComplete((()=>{e(o)}))}))),cameraLookatAnimate:(e,o,n)=>new Promise((r=>{new t.Tween(n).to(o,1e3).easing(t.Easing.Quadratic.In).start().onUpdate((t=>{e.lookAt(t),e._lookAt_=t})).onComplete((()=>{r(e)}))})),cameraLinkageControlsAnimate:(e,o,n,r)=>new Promise((i=>{new t.Tween(o.position).to(n,1e3).easing(t.Easing.Quadratic.In).start().onUpdate((()=>{const t=e.target;o.lookAt(t),o._lookAt_=t})),new t.Tween(e.target).to(r,1e3).easing(t.Easing.Quadratic.In).start().onComplete((()=>{i(o)}))})),createSpriteAnimate:(t,o,n=1,r=10)=>{let i=[0,r/2,r],a=[...o,o[0],o[1]+n,o[2],...o],s=new e.KeyframeTrack("sprite.position",i,a),l=new e.AnimationClip("sprite_up_down",r,[s]);const c=new e.AnimationMixer(t),d=c.clipAction(l);return d.timeScale=5,d.play(),t.__action__=d,t.__mixer__=c,t},getPlanePosition:(e,t,o)=>{let n=e.clientWidth/2,r=e.clientHeight/2,i=t.position.clone();const a=t.scale;i.y+=a.x/2;let s=i.project(o);return{left:s.x*n+n,top:-s.y*r+r}},findObjectsByHasProperty:(e,t,o="name")=>{let n=[];if(!e||!e.length)return[];return function e(r){r.forEach((r=>{const i=r[o];"string"==typeof i&&t.some((e=>i.indexOf(e)>-1))&&n.push(r),r.children&&e(r.children)}))}(e),n},getStatusOffset:V,createText:(t,o,n=16777215,i)=>{const a=V("TEXT",t,i);let s=t.font||{},l=new r(t.name||"",{font:o,size:s.size||10,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const c=a.rotation;l.rotateX(c.x),l.rotateY(c.y),l.rotateZ(c.z);const d=a.position;l.computeBoundingBox(),l.computeVertexNormals();let u=.5*(l.boundingBox.max.x-l.boundingBox.min.x),p=.5*(l.boundingBox.max.z-l.boundingBox.min.z),m=new e.MeshPhongMaterial({color:null!=s.color?s.color:n,flatShading:!1}),h=new e.Mesh(l,m);return h.castShadow=!0,h.position.set((d.x||0)-u,d.y||0,(d.z||0)-p),h.name="text",h._isText_=!0,h},createWarning:(t,o,n,r,i=100,a=1)=>{if(!n)return;const s=V("WARNING",o,r);let l=new e.Group,c=N(n);c.scale.set(a,a,a);const d=s.position;c.position.set(d.x,d.y,d.z);const u=s.rotation;c.rotation.set(u.x,u.y,u.z),l.add(c);let p=new e.PointLight(12717056,8,i,0);p.name="灯光",p.position.y=d.y+30,l.add(p),l.name=t;let m=new e.AnimationMixer(l),h=new e.KeyframeTrack("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),f=new e.KeyframeTrack("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),g=new e.KeyframeTrack("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),v=new e.AnimationClip("warning_",1,[h,f,g]),w=m.clipAction(v);return w.paused=!0,w.play(),l.visible=!1,l._isWarning_=!0,{group:l,action:w,mixer:m}},createStatusMark:(e,t,o,n)=>{if(!t)return;const r=V(n?"DISABLED":"STATUS",e,o);let i=N(t);const a=r.position;i.position.set(a.x,a.y,a.z);const s=r.rotation;return i.rotation.set(s.x,s.y,s.z),i.visible=!1,i._isStatus_=!0,i},isType:Q,isObject:K,isDOM:Z,deepClone:Y,deepMerge:$,checkUrl:j,random:q}),te={container:document.body,width:window.innerWidth,height:window.innerHeight,baseUrl:"",bgColor:null,bgUrl:null,env:null,scale:1,fog:{visible:!1,near:100,far:1e3},render:{antialias:!0,logarithmicDepthBuffer:!0,preserveDrawingBuffer:!1},controls:{visible:!0,autoRotate:!1,autoRotateSpeed:2,enableDamping:!1,dampingFactor:.25,enablePan:!0,enableRotate:!0,enableZoom:!0,maxAzimuthAngle:1/0,minAzimuthAngle:1/0,minDistance:1,maxDistance:2e3,minPolarAngle:0,maxPolarAngle:Math.PI,maxTargetRadius:1/0,rotateSpeed:1,screenSpacePanning:!0},ambientLight:{visible:!0,color:16777215,intensity:1.5},directionalLight:{visible:!0,helper:!1,position:[500,1e3,800],position2:[-500,800,-800],light2:!0,color:16777215,intensity:1.5},camera:{helper:!1,near:1,far:1e4,position:[-350,510,700]},cruise:{visible:!1,enabled:!1,runing:!1,helper:!1,points:[],segment:2,tension:0,baseUrl:"",repeat:[.1,1],width:15,speed:1,mapSpeed:.006,offset:10,factor:1,auto:!1,animateBack:void 0,alway:!1},grid:{visible:!1,opacity:.3,transparent:!0,width:800,divisions:80,centerLineColor:10592673,gridColor:10592673,fork:!1,forkSize:1.4,forkColor:10592673},axes:{visible:!1,size:50}};const oe=()=>({initCSS3DRender:(e,t)=>{const{width:o,height:n}=e,r=new l;return r.setSize(o,n),r.domElement.style.position="absolute",r.domElement.style.left="0px",r.domElement.style.top="0px",r.domElement.style.pointerEvents="none",t.appendChild(r.domElement),r},createCSS3DDom:e=>{const{name:t,className:o="",onClick:n,position:r,sprite:i}=e,a=document.createElement("div");a.innerHTML=t,a.className=o;const s=i?new c(a):new d(a);return a.style.pointerEvents=n?"auto":"none",a.style.position="absolute","function"==typeof n&&a.addEventListener("click",n),r&&s.position.set(...r),s}}),{createCSS3DDom:ne}=oe(),re=()=>({visible:!0,enabled:!1,runing:!1,helper:!1,points:[],segment:2,close:!0,tension:0,baseUrl:"",mapUrl:k("arrow.png"),repeat:[.1,1],width:15,speed:1,mapSpeed:.006,offset:10,factor:1,index:0,auto:!1,tube:!1,color:16777215,radius:1,radialSegments:1,animateBack:void 0,alway:!1}),ie=()=>{let t,o,n,r=re();const i=(o,i)=>{n=new e.Mesh(new e.SphereGeometry(2),new e.MeshBasicMaterial({color:0,opacity:.8,depthTest:!1,transparent:!0})),o.add(n);const a=(new e.BufferGeometry).setFromPoints(i.concat(i[0])),s=new e.LineBasicMaterial({color:255,opacity:1,depthTest:!1,transparent:!0}),l=new e.Line(a,s);o.add(l);const c=new e.TubeGeometry(t,100,r.width/2,3,!0),d=new e.MeshLambertMaterial({color:16711935,opacity:.1,depthTest:!1,transparent:!0}),u=new e.Mesh(c,d),p=new e.MeshBasicMaterial({color:16715760,opacity:.3,wireframe:!0,depthTest:!1,transparent:!0}),m=new e.Mesh(c,p);u.add(m),o.add(u)},a=()=>{var e;return 900*(null!==(e=r.segment)&&void 0!==e?e:2)},s=()=>null==t?void 0:t.getPoints(a()),l=(t,o)=>new e.Vector3(o.x,o.y+t,o.z),c=e=>{if(!r.enabled)return;switch(e.keyCode){case 38:case 87:r.runing?(r.factor*=1.5,r.factor>10&&(r.factor=10)):r.index+=5;break;case 83:case 40:r.runing||(r.index-=5,r.index<0&&(r.index=a()))}},d=e=>{if(!r.enabled)return;r.factor=1;switch(e.keyCode){case 32:r.runing=!r.runing;break;case 38:case 87:r.runing||(r.index+=10);break;case 83:case 40:r.runing||(r.index-=10,r.index<0&&(r.index=a()))}};return{createCruise:(n,a)=>{r=$(re(),n);const{points:l,tension:c,mapUrl:d,baseUrl:u,repeat:p,width:m,helper:h,close:f,tube:g,color:v,radius:w,radialSegments:y}=r,x=[];for(let t=0;t<l.length;t++){const o=l[t];x.push(new e.Vector3(o[0],o[1],o[2]))}t=new e.CatmullRomCurve3(x,f,"catmullrom",null!=c?c:0),t=new e.CatmullRomCurve3(s(),f,"catmullrom",null!=c?c:0);const b=new e.Group;o=(new e.TextureLoader).load(E(d,u),(t=>{t.wrapS=e.RepeatWrapping,t.repeat.x=p[0],t.repeat.y=p[1],t.anisotropy=a.capabilities.getMaxAnisotropy()}));const L=new e.MeshPhongMaterial({color:v,map:o,opacity:.9,transparent:!0,depthTest:!0,side:e.FrontSide}),z=new e.Vector3(0,1,0),P=new C;P.set(s(),w,y,z,!1);const _=g?new M:new S;_.update(P,g?{radius:w,radialSegments:y,progress:1,startRad:0}:{width:m,arrow:!1,progress:1,side:"both"},!1);const B=new e.Mesh(_,L);return b.add(B),b.name="cruise",h&&i(b,x),b.renderOrder=99,b},updateCruise:e=>{r=$(r,e)},cruiseAnimate:e=>{if(!e)return;if(!t)return;const{mapSpeed:i,speed:s,factor:c,enabled:d,runing:u,offset:p,helper:m,auto:h,animateBack:f}=r;if(o&&(o.offset.x-=i),!(h||u&&d))return;(h||u&&d)&&(r.index+=c*s);const g=a(),v=r.index%g/g;let w=v+.001;w>1&&(w-=1);const y=t.getPointAt(w);if(m&&n){const e=l(p,y);n.position.copy(e)}const x=l(p,t.getPointAt(v));if(!h||u&&d){e.position.copy(x);const t=l(p,y);e._lookAt_=t,e.lookAt(t)}"function"==typeof f&&f(x,y,t,v)},bindEvent:()=>{window.addEventListener("keydown",c,!1),window.addEventListener("keyup",d,!1)},removeEvent:()=>{window.removeEventListener("keyup",d),window.removeEventListener("keydown",c)}}},ae=()=>({createFork:(t={})=>{const{width:o=800,divisions:n=80,forkSize:r=1.4,forkColor:i=10592673}=t;let a=o/n,s=-o/2;const l=new e.Group;for(let t=0;t<=n;t++)for(let o=0;o<=n;o++){const n=s+t*a,c=s+o*a,d=new e.PlaneGeometry(r,r/5),u=new e.MeshLambertMaterial({color:i,transparent:!0,opacity:.9}),p=new e.Mesh(d,u);p.rotateX(.5*-Math.PI),p.position.set(n,0,c);const m=p.clone();m.rotateZ(.5*Math.PI),l.add(p,m)}return l}});var se,le,ce=Object.freeze({__proto__:null,useConvertData:()=>({transformGeoJSON:e=>{let t=e.features;for(let e=0;e<t.length;e++){const o=t[e];"Polygon"===o.geometry.type&&(o.geometry.coordinates=[o.geometry.coordinates])}return e}}),useCountryLine:()=>{const t=(t,o,n="LineLoop")=>{let r;if("Line2"===n){const e=new s;e.setPositions(t),r=new i(e,o),r.name="countryLine2",r.computeLineDistances()}else{const i=new e.BufferGeometry;i.setFromPoints(t),r=new e[n](i,o),r.name="countryLine"}return r};return{createCountryFlatLine:(o,n,r="LineLoop")=>{let i={color:65535,linewidth:1,depthTest:!1};i=$(i,n);let s=new e.LineBasicMaterial(i);"Line2"===r&&(s=new a(i));let l=o.features,c=new e.Group;for(let o=0;o<l.length;o++){const n=l[o].geometry.coordinates;for(let o=0;o<n.length;o++){const i=n[o],a=[];"Line2"===r?i.forEach((e=>{e.forEach((e=>{a.push(e[0],0,-e[1])}))})):i.forEach((t=>{t.forEach((t=>{a.push(new e.Vector3(t[0],t[1],0))}))}));let l=t(a,s,r);c.add(l)}}return c},getPoints:(t,o=0,n)=>{let r=t.features;const i=[];for(let t=0;t<r.length;t++){const a=r[t].geometry.coordinates;for(let t=0;t<a.length;t++)a[t].forEach((t=>{t.forEach((t=>{n?i.push(new e.Vector3(t[0],o,-t[1])):i.push(t[0],o,-t[1])}))}))}return i}}},useMapBar:(t={})=>{let o=$({height:10,size:2,factor:1,color1:1048575,color2:16777215},t);return{createBar:(t={},n={})=>{var r;o=$(o,n);let{size:i,height:a,factor:s,color1:l,color2:c}=o;i*=s,a*=s,a*=null!==(r=t.heightRatio)&&void 0!==r?r:s;const[d,u,p]=t.position||[0,0,0],m=new e.Group,h=new e.BoxGeometry(i,i,a),f=new e.ShaderMaterial({depthTest:!1,transparent:!0,vertexColors:!1,uniforms:{uColor1:{value:new e.Color(l)},uColor2:{value:new e.Color(c)},uOpacity:{value:.6}},vertexShader:"\n\t\t\t\tvarying vec3 vColor;\n\t\t\t\tuniform vec3 uColor1;\n\t\t\t\tuniform vec3 uColor2;\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat percent = (position.z + 0.0) / 100.0; // 计算当前像素点在立方体高度上的百分比\n\t\t\t\t\tvColor = mix(uColor1.rgb, uColor2.rgb, percent);\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tvarying vec3 vColor;\n\t\t\t\tuniform float uOpacity;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = vec4(vColor, uOpacity);\n\t\t\t\t}\n\t\t\t"}),g=new e.Mesh(h,f);if(m.add(g),m.name="柱状图",m.position.set(d,u,p+a/2),m.renderOrder=99,t.label){const{name:e="",className:o="",onClick:n}=t.label,r=ne({name:e,className:o,position:[0,0,a/2],onClick:n});r.rotateX(.5*Math.PI),m.add(r)}return m}}},useOutline:(t={})=>{let o=$({size:.1,color:16085360,range:500,factor:1,speed:6},t);const n=e=>{const t=e.material,n=t.uniforms.uLength.value;t.uniforms.uIndex.value+=o.speed,t.uniforms.uIndex.value>=n&&(t.uniforms.uIndex.value=0)};return{createOutline:(t,n={})=>{o=$(o,n);const{size:r,factor:i,range:a,color:s}=o,l=new Float32Array(t),c=new e.BufferGeometry;c.setAttribute("position",new e.BufferAttribute(l,3));const d=new Float32Array(Math.floor(l.length/3)).map(((e,t)=>t));c.setAttribute("aIndex",new e.BufferAttribute(d,1));const u=new e.ShaderMaterial({vertexShader:"\n\t\t\t\tattribute float aOpacity;\n\t\t\t\tuniform float uSize;\n\n\t\t\t\tattribute float aIndex;\n\t\t\t\tvarying vec3 vp;\n\t\t\t\tvarying float vertexIndex;\n\n\t\t\t\tvoid main(){\n\t\t\t\t\tgl_Position = projectionMatrix*modelViewMatrix*vec4(position,1.0);\n\t\t\t\t\tgl_PointSize = uSize;\n\n\t\t\t\t\tvp = position;\n\t\t\t\t\tvertexIndex = aIndex;\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tvarying float vertexIndex;\n\t\t\t\tuniform vec3 uColor;\n\t\t\t\tuniform float uIndex;\n\t\t\t\tuniform float uRange;\n\n\t\t\t\tfloat invert(float n){\n\t\t\t\t\treturn 1.-n;\n\t\t\t\t}\n\n\t\t\t\tvoid main(){\n\t\t\t\t\tfloat uOpacity = 1.0;\n\t\t\t\t\tif(vertexIndex <= uIndex || vertexIndex >= (uRange + uIndex)){\n\t\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}\n\t\t\t\t\tuOpacity = (vertexIndex - uIndex)/uRange;\n\t\t\t\t\tif ( uOpacity < 0.2) {\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}\n\t\t\t\t\tvec2 uv=vec2(gl_PointCoord.x,invert(gl_PointCoord.y));\n\t\t\t\t\tvec2 cUv=2.*uv-1.;\n\t\t\t\t\tvec4 color=vec4(1./length(cUv));\n\t\t\t\t\tcolor*=uOpacity;\n\t\t\t\t\tcolor.rgb*=uColor;\n\t\t\t\t\tgl_FragColor=color;\n\t\t\t\t}\n\t\t\t",transparent:!0,depthTest:!1,uniforms:{uSize:{value:r*i},uIndex:{value:0},uLength:{value:d.length},uRange:{value:a},uColor:{value:new e.Color(s)}}}),p=new e.Points(c,u);return p.name="轮廓",p.scale.setScalar(i),p},update:n,outlineUpdate:n}},useMarkLight:(o={})=>{let n=$({pointTextureUrl:k("point.png"),circleTextureUrl:k("circle.png"),lightTextureUrl:k("light.png"),factor:1,color:65535},o);const r=new e.TextureLoader;return{createMarkLight:(o=[0,0,0],i=10,a={})=>{n=$(n,a);const s=new e.Group,l=new e.PlaneGeometry(i/6.219,i);l.rotateX(-Math.PI/2),l.translate(0,0,i/2);const c=new e.MeshBasicMaterial({map:r.load(n.lightTextureUrl),color:n.color,transparent:!0,depthWrite:!1,side:e.DoubleSide});let d=new e.Mesh(l,c);d.rotateX(Math.PI),d.position.z=i,d.renderOrder=3,d.name="光柱 01";let u=d.clone();u.name="光柱 02",u.rotateZ(Math.PI/2);const p=(()=>{const t=new e.PlaneGeometry(3,3),o=new e.MeshBasicMaterial({map:r.load(n.pointTextureUrl),color:n.color,side:e.DoubleSide,transparent:!0,depthWrite:!1});let i=new e.Mesh(t,o);i.renderOrder=1,i.name="底部光点";const a=.3*n.factor;return i.scale.setScalar(a),i})(),m=(()=>{const o=new e.PlaneGeometry(3,3),i=new e.MeshBasicMaterial({map:r.load(n.circleTextureUrl),color:n.color,side:e.DoubleSide,opacity:0,transparent:!0,depthWrite:!1});let a=new e.Mesh(o,i);a.renderOrder=2,a.name="createLightHalo";const s=.5*n.factor;a.scale.setScalar(s);const l=q(0,2e3);return a.tween1=new t.Tween({scale:s,opacity:0}).to({scale:1.5*s,opacity:1},1e3).delay(l).onUpdate((e=>{let{scale:t,opacity:o}=e;a.scale.setScalar(t),a.material.opacity=o})),a.tween2=new t.Tween({scale:1.5*s,opacity:1}).to({scale:2*s,opacity:0},1e3).onUpdate((e=>{let{scale:t,opacity:o}=e;a.scale.setScalar(t),a.material.opacity=o})),a.tween1.chain(a.tween2),a.tween2.chain(a.tween1),a.tween1.start(),a})();s.add(d,u,p,m);const[h,f,g]=o;return s.position.set(h,f,g),s.rotateX(.5*Math.PI),s.name="光柱标记",s}}},useFence:()=>{const t=[1,.8],o=.2,n=(new e.TextureLoader).load(k("fenceMap0.png"),(n=>{n.wrapT=e.RepeatWrapping,n.repeat.x=t[0],n.repeat.y=t[1],n.offset.y=o})),r=(new e.TextureLoader).load(k("fenceMap1.png"),(n=>{n.wrapT=e.RepeatWrapping,n.repeat.x=t[0],n.repeat.y=t[1],n.offset.x=o})),i=(new e.TextureLoader).load(k("fenceMap2.png"),(t=>{t.wrapS=e.RepeatWrapping,t.wrapT=e.RepeatWrapping})),a=(t,o,a)=>{const s=[];for(let e=0;e<o.length;e++){const n=o[e];s.push(...t[n])}const l=new e.BufferGeometry,c=new Float32Array(s);l.setAttribute("position",new e.BufferAttribute(c,3));const d=o.length,u=new e.BufferAttribute(new Float32Array(3*d),3);l.setAttribute("normal",u);for(let e=0;e<d;e++)u.setXYZ(e,0,0,0);const p=new e.BufferAttribute(new Float32Array([1,1,0,1,0,0,0,0,1,0,1,1]),2);l.setAttribute("uv",p);const m=new e.MeshPhongMaterial({color:a,map:n,transparent:!0,blending:e.AdditiveBlending,side:e.DoubleSide}),h=new e.MeshPhongMaterial({color:a,map:r,transparent:!0,blending:e.AdditiveBlending,side:e.DoubleSide});var f=new e.MeshPhongMaterial({color:a,map:i,opacity:.5,transparent:!0,side:e.DoubleSide});const g=new e.Mesh(l,m),v=new e.Group,w=new e.Mesh(l,h),y=new e.Mesh(l,f);return v.add(g,w,y),v};return{createFence:(t,o=11009923)=>{const n=new e.Group;var r=new e.BoxHelper(t,o);r.update();const i=r.geometry.getAttribute("position").array,s=[];for(let e=0;e<i.length;e+=3){const t=i[e],o=i[e+1],n=i[e+2];s.push([t,o,n])}const l=a(s,[0,1,2,2,3,0],o),c=a(s,[4,5,6,6,7,4],o),d=a(s,[4,0,3,3,7,4],o),u=a(s,[1,5,6,6,2,1],o);return n.add(l,c,d,u),n},fenceAnimate:(e=1)=>{const t=.008*e;if(n){let e=n.offset.y-t;e<0&&(e=o),n.offset.y=e}if(r){let e=r.offset.y-t;e<0&&(e=o),r.offset.y=e}}}},useCorrugatedPlate:(t={})=>{let o=$({range:100,interval:.8,size:.2,color:47273,light:881527,factor:1},t);const n=(e,t)=>{const o=e.material,n=o.uniforms.uRange.value,r=o.uniforms.uLength.value;o.uniforms.uRadius.value+=t*(n/4),o.uniforms.uRadius.value>=n+r&&(o.uniforms.uRadius.value=0)};return{createCorrugatedPlate:(t={})=>{o=$(o,t);let{range:n,color:r,light:i,factor:a}=o;n*=a;const s=(()=>{let{range:t,interval:n,size:r,factor:i}=o;t*=i,n*=i,r*=i;const a=[],s=Math.floor(t/n);for(let t=-s;t<=s;t++)for(let o=-s;o<=s;o++){const i=new e.PlaneGeometry(r,r),s=t*n,l=o*n,c=new e.Matrix4,d=new e.Vector3(s,-r,l),u=new e.Quaternion,p=new e.Euler,m=new e.Vector3(1,1,1);u.setFromEuler(p),c.compose(d,u,m),i.applyMatrix4(c),a.push(i)}return a})(),l=u.mergeGeometries(s),c=new e.ShaderMaterial({uniforms:{uColor:{value:new e.Color(i)},uTcolor:{value:new e.Color(r)},uRadius:{value:1.25},uLength:{value:n/10},uRange:{value:n}},vertexShader:"\n\t\t\t\tvarying vec3 vp;\n\t\t\t\tvoid main(){\n\t\t\t\t\tvp = position;\n\t\t\t\t\tgl_Position\t= projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tvarying vec3 vp;\n\t\t\t\tuniform vec3 uColor;\n\t\t\t\tuniform vec3 uTcolor;\n\t\t\t\tuniform float uRadius;\n\t\t\t\tuniform float uLength;\n\t\t\t\tfloat getLeng(float x, float y){\n\t\t\t\t\treturn\tsqrt((x-0.0)*(x-0.0)+(y-0.0)*(y-0.0));\n\t\t\t\t}\n\t\t\t\tvoid main(){\n\t\t\t\t\tfloat uOpacity = 0.8;\n\t\t\t\t\tvec3 vColor = uColor;\n\t\t\t\t\tfloat length = getLeng(vp.x,vp.z);\n\t\t\t\t\tif ( length <= uRadius && length > uRadius - uLength ) {\n\t\t\t\t\t\tfloat op = sin( (uRadius - length) / uLength ) ;\n\t\t\t\t\t\tuOpacity = op;\n\t\t\t\t\t\tif ( vp.y < 0.0 ) {\n\t\t\t\t\t\t\tvColor = uColor * op;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvColor = uTcolor;\n\t\t\t\t\t\t};\n\t\t\t\t\t\tvColor = uTcolor;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(vColor,uOpacity);\n\t\t\t\t}\n\t\t\t",transparent:!0,depthWrite:!1,side:e.DoubleSide}),d=new e.Mesh(l,c);return d.name="波纹板",d},update:n,corrugatedPlateUpdate:n}},useDiffusion:()=>{let t;return{createDiffusion:(o=10,n=16715760,r=5)=>{const i=new e.PlaneGeometry(o,o,1,1),a=["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(""),s=["varying vec2 vUv;","uniform vec3 uColor;","uniform float uOpacity;","uniform float uSpeed;","uniform float uSge;","uniform float time;","float PI = 3.14159265;","float drawCircle(float index, float range) {","\tfloat opacity = 1.0;","\tif (index >= 1.0 - range) {","\t\topacity = 1.0 - (index - (1.0 - range)) / range;","\t} else if(index <= range) {","\t\topacity = index / range;","\t}","\treturn opacity;","}","float distanceTo(vec2 src, vec2 dst) {","\tfloat dx = src.x - dst.x;","\tfloat dy = src.y - dst.y;","\tfloat dv = dx * dx + dy * dy;","\treturn sqrt(dv);","}","void main() {","\tfloat iTime = -time * uSpeed;","\tfloat opacity = 0.0;","\tfloat len = distanceTo(vec2(0.5, 0.5), vec2(vUv.x, vUv.y));","\tfloat size = 1.0 / uSge;","\tvec2 range = vec2(0.65, 0.75);","\tfloat index = mod(iTime + len, size);","\tvec2 cRadius = vec2(0.06, 0.12);","\tif (index < size && len <= 0.5) {","\t\tfloat i = sin(index / size * PI);","\t\tif (i >= range.x && i <= range.y){","\t\t\tfloat t = (i - range.x) / (range.y - range.x);","\t\t\tfloat r = 0.3;","\t\t\topacity = drawCircle(t, r);","\t\t}","\t\topacity *=\t1.0 - len / 0.5;","\t};","\tgl_FragColor = vec4(uColor, uOpacity * opacity);","}"].join("");t=new e.ShaderMaterial({uniforms:{uColor:{value:new e.Color(n)},uOpacity:{value:1},uSpeed:{value:.1},uSge:{value:r},uRadius:{value:o/2},time:{value:0}},transparent:!0,vertexShader:a,fragmentShader:s,depthTest:!1,blending:e.AdditiveBlending,side:e.DoubleSide});return new e.Mesh(i,t)},updateDiffusion:(e=1)=>{if(!t)return;const o=.001*performance.now()*e;t.uniforms.time.value=o}}},useFlywire:(t={})=>{let o,n,r=$({depth:0,height:4,divisions:1e3,color:16777215,flyColor:16761095,pointColor:16715760,pointWidth:2.5,flyPointWidth:2.4,tubularSegments:256,radius:.5,radialSegments:8,closed:!1,length:100,factor:1,speed:4},t);const i=t=>{const[o,i]=t;let{pointWidth:a,depth:s,factor:l}=r;const c=a*l;s*=l;const d=new e.PlaneGeometry(c,c,1,1),u=new e.Mesh(d,n);return u.position.set(o,s,-i),u.rotateX(.5*-Math.PI),u},a=(t={})=>{r=$(r,t),o=new e.ShaderMaterial({depthTest:!1,uniforms:{uColor:{value:new e.Color(r.flyColor)},uIndex:{value:0},uTotal:{value:r.divisions},uWidth:{value:r.flyPointWidth},uLength:{value:r.length}},vertexShader:["attribute float aIndex;","uniform float uIndex;","uniform float uWidth;","uniform vec3 uColor;","varying float vSize;","uniform float uLength;","void main(){","\t\tvec4 viewPosition = viewMatrix * modelMatrix * vec4(position,1);","\t\tgl_Position = projectionMatrix * viewPosition;","\t\tif(aIndex >= uIndex - uLength && aIndex < uIndex){","\t\t\tvSize = uWidth * ((aIndex - uIndex + uLength) / uLength);","\t\t}","\t\tgl_PointSize = vSize;","}"].join(""),side:e.DoubleSide,fragmentShader:["varying float vSize;","uniform vec3 uColor;","void main(){","\t\tif(vSize<=0.0){","\t\t\tgl_FragColor = vec4(1,0,0,0);","\t\t}else{","\t\t\tgl_FragColor = vec4(uColor,1);","\t\t}","}"].join(""),transparent:!0,vertexColors:!1}),n=new e.ShaderMaterial({uniforms:{uColor:{value:new e.Color(r.pointColor)},uOpacity:{value:1},uSpeed:{value:.1},uSge:{value:4},uRadius:{value:r.pointWidth*r.factor/2},time:{value:0}},transparent:!0,depthTest:!1,vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(""),fragmentShader:["varying vec2 vUv;","uniform vec3 uColor;","uniform float uOpacity;","uniform float uSpeed;","uniform float uSge;","uniform float time;","float PI = 3.14159265;","float drawCircle(float index, float range) {","\tfloat opacity = 1.0;","\tif (index >= 1.0 - range) {","\t\topacity = 1.0 - (index - (1.0 - range)) / range;","\t} else if(index <= range) {","\t\topacity = index / range;","\t}","\treturn opacity;","}","float distanceTo(vec2 src, vec2 dst) {","\tfloat dx = src.x - dst.x;","\tfloat dy = src.y - dst.y;","\tfloat dv = dx * dx + dy * dy;","\treturn sqrt(dv);","}","void main() {","\tfloat iTime = -time * uSpeed;","\tfloat opacity = 0.0;","\tfloat len = distanceTo(vec2(0.5, 0.5), vec2(vUv.x, vUv.y));","\tfloat size = 1.0 / uSge;","\tvec2 range = vec2(0.65, 0.75);","\tfloat index = mod(iTime + len, size);","\tvec2 cRadius = vec2(0.06, 0.12);","\tif (index < size && len <= 0.5) {","\t\tfloat i = sin(index / size * PI);","\t\tif (i >= range.x && i <= range.y){","\t\t\t// 归一","\t\t\tfloat t = (i - range.x) / (range.y - range.x);","\t\t\t// 边缘锯齿范围","\t\t\tfloat r = 0.3;","\t\t\topacity = drawCircle(t, r);","\t\t}","\t\t// 渐变","\t\topacity *=\t1.0 - len / 0.5;","\t};","\tgl_FragColor = vec4(uColor, uOpacity * opacity);","}"].join("\n"),side:e.DoubleSide})},s=()=>{const e=o,t=e.uniforms.uTotal.value;e.uniforms.uIndex.value+=r.speed,e.uniforms.uIndex.value>=t&&(e.uniforms.uIndex.value=0);const i=.001*performance.now();n.uniforms.time.value=i};return a(),{createFlywireTexture:a,createFlywire:t=>{const n=new e.Group,a=i(t[0]),s=i(t[1]);n.add(a,s);const l=(t=>{const[o,n]=t[0],[i,a]=t[1];let{depth:s,height:l,factor:c,divisions:d}=r;l=(s+l)*c,s*=c;const u=new e.Vector3(o,s,-n),p=new e.Vector3(o+(i-o)/4,l,-(n+(a-n)/4)),m=new e.Vector3(o+3*(i-o)/4,l,-(n+3*(a-n)/4)),h=new e.Vector3(i,s,-a);return new e.CubicBezierCurve3(u,p,m,h).getPoints(d)})(t),c=new e.CatmullRomCurve3(l,!1,"centripetal",.5),d=new e.TubeGeometry(c,r.tubularSegments,r.radius,r.radialSegments,r.closed),u=new e.ShaderMaterial({transparent:!0,opacity:1,depthTest:!1,vertexColors:!1,uniforms:{uColor:{value:new e.Color(r.color)},uOpacity:{value:.6}},vertexShader:["varying vec3 vColor;","uniform vec3 uColor;","void main() {","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join(""),fragmentShader:["uniform vec3 uColor;","uniform float uOpacity;","void main() {","\tgl_FragColor = vec4(uColor, uOpacity);","}"].join("")}),p=new e.Mesh(d,u);p.renderOrder=10;const m=(t=>{const n=new Float32Array(t.map(((e,t)=>t))),r=(new e.BufferGeometry).setFromPoints(t);return r.setAttribute("aIndex",new e.BufferAttribute(n,1)),new e.Points(r,o)})(l);return n.add(p,m),n},update:s,flywireUpdate:s}},useLensflare:(t={})=>{let o=$({mainTextureUrl:k("lensflare0.png"),minorTextureUrl:k("lensflare3.png")},t);const n=new e.TextureLoader,r=n.load(o.mainTextureUrl),i=n.load(o.minorTextureUrl);return{addLensflare:(t,o,n,a)=>{const s=new e.PointLight(16777215,1,2e3,0);s.color.set(t),s.position.set(o,n,a);const l=new p;return l.addElement(new m(r,700,0,s.color)),l.addElement(new m(i,60,.6)),l.addElement(new m(i,70,.7)),l.addElement(new m(i,120,.9)),l.addElement(new m(i,70,1)),s.add(l),s}}},useFileLoader:()=>{const t=h(0);return{load:o=>{const n=new e.FileLoader;return new Promise(((e,r)=>{n.load(o,(t=>{let o={};try{o=JSON.parse(t)}catch(e){}e(o)}),(e=>{let{loaded:o,total:n}=e;t.value=Number((o/n*100).toFixed(0))}),r)}))},progress:t}},useUpload:t=>{const o=$({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/"},t);return{uploadModel:(t,n,r)=>{const{baseUrl:i,dracoPath:a,basisPath:s}=o,l=t[0],c=l.name,d=c.split(".").pop().toLowerCase(),u=new FileReader;u.addEventListener("progress",(e=>{const t="("+Math.floor(e.total/1e3)+" KB)",o=Math.floor(e.loaded/e.total*100)+"%";r&&r({progress:o,filename:c,size:t})})),u.addEventListener("load",(t=>T(void 0,void 0,void 0,(function*(){const o=t.target.result;if(["glb","gltf"].includes(d)){const t=new y,r=new w;r.setDecoderPath(`${i}${a}`),t.setDRACOLoader(r);const l=new x;l.setTranscoderPath(`${i}${s}`),t.setKTX2Loader(l),t.setMeshoptDecoder(b),t.parse(o,"",(o=>{var r,i,a;const s=o.scene.children;let l=new e.Group;s.length>1?l.add(...s):l=s[s.length-1],l.name=(null===(r=l.userData)||void 0===r?void 0:r.name)||c,l.animations.push(...o.animations),n(l),null===(i=t.dracoLoader)||void 0===i||i.dispose(),null===(a=t.ktx2Loader)||void 0===a||a.dispose()}))}else if("fbx"==d){const e=(new v).parse(o,"");n(e)}})))),u.readAsArrayBuffer(l)}}},useCollide:()=>{const t=new e.Raycaster,o=new e.Vector3(0,2,0);return{checkCollide:(n,r,i,a=!0,s=o)=>{const l=r.clone().add(s),c=new e.Vector3;n.getWorldDirection(c),c.normalize(),t.ray.origin.copy(l),t.ray.direction.copy(c);return t.intersectObjects(i,a)}}},useCoord:()=>({getBoundingBox:t=>{var o=new e.Box3;o.expandByObject(t);var n=new e.Vector3;o.getSize(n);var r=new e.Vector3;return o.getCenter(r),{box3:o,center:r,size:n}}}),useRaycaster:()=>{const t=new e.Raycaster,o=new e.Vector2,n={left:0,top:0};return{raycaster:t,pointer:o,style:n,update:(e,t,r=1)=>{const i=t.getBoundingClientRect()||{left:0,top:0};o.x=(e.clientX-i.left)/(t.clientWidth*r)*2-1,o.y=-(e.clientY-i.top)/(t.clientHeight*r)*2+1;const a=t.clientWidth/2,s=t.clientHeight/2;n.left=o.x*a+a,n.top=-o.y*s+s}}},useCruise:ie,useCSS2D:()=>({initCSS2DRender:(e,t)=>{const{width:o,height:n}=e,r=new L;return r.setSize(o,n),r.domElement.style.position="absolute",r.domElement.style.left="0px",r.domElement.style.top="0px",r.domElement.style.pointerEvents="none",t.appendChild(r.domElement),r},createCSS2DDom:e=>{const{name:t,className:o="",onClick:n,position:r}=e,i=document.createElement("div");i.innerHTML=t,i.className=o;const a=new z(i);return i.style.pointerEvents=n?"auto":"none",i.style.position="absolute","function"==typeof n&&i.addEventListener("click",(e=>n(e,a))),r&&a.position.set(...r),a}}),CSS2DRenderer:L,useCSS3D:oe,CSS3DRenderer:l,useFloor:(e={})=>{const o=$({mode:"BA",margin:50},e),n=(e,o,n,r)=>{0!==o.length&&o.forEach((o=>{var i,a,s,l;const c=o._position_,d="UD"==e?(null!==(i=c.y)&&void 0!==i?i:0)+n:null!==(a=c.y)&&void 0!==a?a:0,u="BA"==e?(null!==(s=c.z)&&void 0!==s?s:0)+r:null!==(l=c.z)&&void 0!==l?l:0;new t.Tween(o.position).to({y:d,z:u},500).easing(t.Easing.Quadratic.Out).start()}))};return{floorAnimate:(e,r,i)=>{var a,s,l,c,d,u;const p=void 0!==r&&r>-1,{margin:m,mode:h}=o;for(let o=0;o<e.length;o++){const f=e[o],g=f._position_;const v=(o-(p?r:o))*m;let w=(null!==(a=g.y)&&void 0!==a?a:0)+v,y=r==o?(null!==(s=g.z)&&void 0!==s?s:0)+m:null!==(l=g.z)&&void 0!==l?l:0;const x=r===o&&("UD"===h&&w===f.position.y||"BA"===h&&y===f.position.z);if(x&&(w=null!==(c=g.y)&&void 0!==c?c:0,y=null!==(d=g.z)&&void 0!==d?d:0),"UD"===h){if(f.position.y===w)continue}else if("BA"===h&&f.position.z===y)continue;if(null===(u=f.data)||void 0===u?void 0:u.mark){const e=i(f.data.mark);let t=r==o?m:0;x&&(t=0),n(h,e,v,t)}new t.Tween(f.position).to({y:"UD"===h?w:f.position.y,z:"BA"===h?y:f.position.z},500).easing(t.Easing.Quadratic.Out).start()}}}},useDialog:(e={})=>{const t=f($({show:!1,style:{left:"",top:""},select:[],data:{},title:"",position:{top:0,left:0}},e));return{dialog:t,options:t,show:g(t.show)}},useGrid:ae,useMaterial:()=>{const t=(e,t=.5)=>{const o=e=>{e.material.transparent=!0,e.material.opacity=t};e.isMesh?o(e):e.traverse((e=>{e.isMesh&&o(e)}))},o=e=>({color:e.color,map:e.map,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,emissiveMap:e.emissiveMap,bumpMap:e.bumpMap,normalMap:e.normalMap,displacementMap:e.displacementMap,opacity:e.opacity,transparent:e.transparent,side:e.side}),n=(t,r,i)=>{if(t instanceof Array){let e=t.map((e=>n(e,r,i)));t=e}else r?(t.metalness=.5,t.roughness=0):(t.metalness=.5,t.roughness=1),t=new e.MeshStandardMaterial(Object.assign(Object.assign({},o(t)),{metalness:t.metalness,roughness:t.roughness,side:i?e.DoubleSide:e.FrontSide}));return t},r=(e,t)=>{const o=document.createElement("a");o.style.display="none",document.body.appendChild(o),o.href=URL.createObjectURL(e),o.download=t,o.click(),o.remove()};return{materialReplace:(o,r,i,a=1211922)=>{const s=I.mesh,l=s.animatehName,c=s.transparentName,{type:d,name:u}=i;if(d.indexOf("Light")>-1){if(!i.shadow)return;let t=800;if(i.castShadow=!0,i.shadow.camera.right=t,i.shadow.camera.left=-t,i.shadow.camera.top=t,i.shadow.camera.bottom=-t,"SpotLight"===d){let t=new e.SpotLightHelper(i,i.color);o.add(t)}}else if(r.transformMaterial&&i.isMesh)if(r.opacitySkin&&c.find((e=>u.indexOf(e)>-1))&&t(i,r.opacity),s.receiveShadowName.find((e=>u.indexOf(e)>-1))){i.receiveShadow=!0;const e=r.groundReflection;i.material=n(i.material,e,r.side)}else if(l.find((e=>u.indexOf(e)>-1))){let t=new e.MeshStandardMaterial({color:a,metalness:.6,roughness:.6});i.material=t}else i.isMesh&&(i.castShadow=!0,i.material=n(i.material,r.glisten,r.side))},changeTransparent:t,exportGlb:(e,t,o,n=!0)=>{if(!e)return;const i={binary:n,animations:t};(new P).parse(e,(e=>{if(e instanceof ArrayBuffer)t=o+".glb",r(new Blob([e],{type:"application/octet-stream"}),t);else{((e,t)=>{r(new Blob([e],{type:"text/plain"}),t)})(JSON.stringify(e,null,2),o+".gltf")}var t}),(e=>{console.log("An error happened during parsing",e)}),i)},getAnimations:e=>{const t=[];e.traverse((e=>{t.push(...e.animations)}));const o=[];for(const e of t)o.push(e.clone().optimize());return o},setMetalnessMaterial:(t={color:16777215},n,r)=>new e.MeshStandardMaterial(Object.assign(Object.assign({},o(t)),{metalness:n,roughness:r})),setGlassMaterial:(t={color:16777215},{metalness:n=0,roughness:r=0,envMapIntensity:i=0,transmission:a=0,ior:s=0})=>new e.MeshPhysicalMaterial(Object.assign(Object.assign({},o(t)),{metalness:n,roughness:r,envMapIntensity:i,transmission:a,ior:s})),centerBoxHelper:(t,o=16711680)=>{var n=new e.BoxHelper(t,o);n.update();return{helper:n,center:(new e.Box3).setFromObject(t).getCenter(new e.Vector3)}}}},useMoveAnimate:()=>{let t;const o={index:0,length:0,runing:!1,model:void 0,speed:1,endCallback:void 0,rungingCall:void 0},n=e=>null==t?void 0:t.getPoints(e),r=(e=!0)=>{if(o.runing=!1,e){const e=o.index-1;o.model.position.copy((e=>{let n=e/o.length;return n>1?n=1:n<0&&(n=0),t.getPointAt(n)})(e))}};return{createMove:(r,i,a,s)=>{const l=r.position,c=Math.atan2(-i.z+l.z,i.x-l.x);r.rotation.y=.5*Math.PI+c;const d=l.distanceTo(i);let u=Math.floor(d/o.speed);u<2&&(u=2);const p=[l,i];t=new e.CatmullRomCurve3(p,!1,"catmullrom",0),t=new e.CatmullRomCurve3(n(u),!1,"catmullrom",0),o.model=r,o.index=0,o.length=u,o.rungingCall=a,o.endCallback=s,o.runing=!0},moveAnimate:(e=1)=>{if(!o.runing)return;o.index+=e;let n=o.index/o.length;n>1&&(n=1);const i=t.getPointAt(n);o.model.position.copy(i),n>=1?(o.runing=!1,"function"==typeof o.endCallback&&o.endCallback(i)):"function"==typeof o.rungingCall&&o.rungingCall(i,r)}}},useRoam:()=>{let t,o={runing:!1,segment:2,close:!0,tension:0,offset:0,points:[],factor:1,speed:1,index:0,animateBack:void 0};const n=(n={})=>{if(t)return;o=$({runing:!1,segment:2,close:!0,tension:0,offset:0,points:[],factor:1,speed:1,index:0,animateBack:void 0},n);const{points:i,tension:a,close:s}=o,l=[];for(let t=0;t<i.length;t++){const o=i[t];l.push(new e.Vector3(o[0],o[1],o[2]))}t=new e.CatmullRomCurve3(l,s,"catmullrom",null!=a?a:0),t=new e.CatmullRomCurve3(r(),s,"catmullrom",null!=a?a:0)},r=()=>null==t?void 0:t.getPoints(i()),i=()=>{var e;return 1e3*(null!==(e=o.segment)&&void 0!==e?e:2)},a=(t,o)=>new e.Vector3(o.x,o.y+t,o.z);return{createRoam:n,updateRoam:e=>{o=$(o,e)},executeRoam:(e,n)=>{if(!e||!n)return;if(!t)return;const{runing:r,offset:s,factor:l,speed:c,animateBack:d}=o;if(!r)return;o.index+=l*c;const u=i(),p=o.index%u/u;let m=p+.01;m>1&&(m-=1);const h=t.getPointAt(m),f=a(s,t.getPointAt(p)),g=a(s,h);n.target=g,e._lookAt_=g,e.lookAt(n.target),"function"==typeof d&&d(f,h,t,p)},pause:()=>{o.runing=!1},play:()=>{o.runing=!0},reset:e=>{t=void 0,n(e)},getStatus:()=>o.runing}},useKeyboardState:()=>{const e=["shift","ctrl","alt","meta"],t={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,tab:9},o={},n={};let r,i;const a=(e,t)=>{var r=e.keyCode;o[r]=t,n.shift=e.shiftKey,n.ctrl=e.ctrlKey,n.alt=e.altKey,n.meta=e.metaKey},s=e=>{a(e,!0),"function"==typeof r&&r(e)},l=e=>{a(e,!1),"function"==typeof i&&i(e)};document.addEventListener("keydown",s,!1),document.addEventListener("keyup",l,!1);const c=r=>{for(var i=r.split("+"),a=0;a<i.length;a++){var s=i[a];if(!(-1!==e.indexOf(s)?n[s]:-1!=Object.keys(t).indexOf(s)?o[t[s]]:o[s.toUpperCase().charCodeAt(0)]))return!1}return!0};return{keyboardPressed:e=>Array.isArray(e)?e.findIndex(c)>-1:c(e),insertEvent:(e,t)=>{r=e,i=t},destroyEvent:()=>{document.removeEventListener("keydown",s,!1),document.removeEventListener("keyup",l,!1)}}},useBackground:(t="")=>{const o=["216","217","218","219","220","221","222","223","224","225","226"],n=o.findIndex((e=>e==t)),r=h(n<0?0:n),i=e=>{const t=o[r.value];t&&(s(e,t),r.value++,r.value>=o.length&&(r.value=0))},a=e=>["posX.jpeg","negX.jpeg","posY.jpeg","negY.jpeg","posZ.jpeg","negZ.jpeg"].map((t=>((e,t)=>new URL(`../assets/imgs/sky/${e}/${t}`,import.meta.url).href)(e,t))),s=(t={},o)=>{const n=a(o);if("function"==typeof t.setBgTexture)t.setBgTexture(n);else if(Array.isArray(n)){const o=(new e.CubeTextureLoader).load(n);t.background=o}else t.background=(new e.TextureLoader).load(n)};return{skys:o,index:r,change:i,changeBackground:i,load:s,getBgGroup:a,backgroundLoad:s}},useModelLoader:(t={})=>{let o;const n=$({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},t),r=f({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),i={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},a=new Map,s=new B;s.setDecoderPath(n.baseUrl+n.dracoPath);const l=new _;l.setDRACOLoader(s);const c=new x;c.setTranscoderPath(n.baseUrl+n.basisPath),l.setKTX2Loader(c),l.setMeshoptDecoder(b);const d=e=>{const t=e.loaded,o=r.total;let n=Number((t+r.loaded)/o*100);n>100&&(n=100),r.percentage=Number(n.toFixed(2))},u=(t,o,r,i)=>{if(!r)return;const{baseUrl:s,colorMeshName:l}=n,{mapUrl:c,key:d,mapMeshName:u,repeat:p=[1,1]}=t;let m;c&&u&&(m=(new e.TextureLoader).load(E(c,s)),m.wrapS=e.RepeatWrapping,m.wrapT=e.RepeatWrapping,m.repeat.set(p[0],p[1]));const h=N(r);return h.traverse((t=>{t.isMesh&&m&&t.name.indexOf(u)>-1?t.material=new e.MeshLambertMaterial({side:e.DoubleSide,transparent:!0,opacity:0,map:m.clone()}):W(t,o,l||[])})),c&&u&&(h._mapMeshName_=u),h.animations=i,d&&a.set(d,h),h},p=(t,r=0)=>new Promise((i=>T(void 0,void 0,void 0,(function*(){var a;n.indexDB.cache||i(null);const s=e.Cache.get(t);if(s)s instanceof ArrayBuffer?(d({loaded:s.byteLength}),l.parse(s,"",(o=>{e.Cache.add(t,o),i(o)}))):(d({loaded:r*n.modelSizeKB}),setTimeout((()=>{i(s)}),10));else{const r=yield G(o,(null===(a=n.indexDB)||void 0===a?void 0:a.tbName)||I.indexdb.tbName,t);if(r&&r.data){const t=r.data;"string"==typeof t?(d({loaded:t.length}),e.Cache.add(r.path,t),setTimeout((()=>{i(t)}),10)):(d({loaded:t.byteLength}),l.parse(t,"",(t=>{e.Cache.add(r.path,t),i(t)})))}else i(null)}})))),m=t=>{var r;if(!n.indexDB.cache)return;const i=e.Cache.get(t);if(i&&o){const e=(null===(r=n.indexDB)||void 0===r?void 0:r.tbName)||I.indexdb.tbName;o.transaction(e,"readwrite").objectStore(e).add({path:t,data:i})}},h=(t,o)=>{const{key:r,url:i="",size:a=0}=t,{baseUrl:s,colors:c}=n;return new Promise(((n,h)=>T(void 0,void 0,void 0,(function*(){let f=c.normal[r]||c.normal.color;f=H(f)[0];const g=E(i,s),v=yield p(g,a);if(v){const e=v.scene.children[0],o=u(t,f,e,v.animations);return void n(o)}let w=(g.split(".").pop()||"").toLowerCase();if("glb"!==w)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+w);l.load(g,(o=>{const r=o.scene.children;let i=new e.Group;r.length>1?i.add(...r):i=r[r.length-1];const a=u(t,f,i,o.animations);m(g),n(a)}),(e=>{d(e),"function"==typeof o&&o(e)}),h)}))))},g=(t,o={})=>{o=$({color:57599,wireframe:!0,opacity:.5,filter:[],filterMatch:[]},o),t.traverse((t=>{var n;(null===(n=o.filter)||void 0===n?void 0:n.includes(t.name))||v(t.name,o.filterMatch)||t.isMesh&&(t.__material__||(t.__material__=t.material),t.material=new e.MeshBasicMaterial({color:o.color,wireframe:o.wireframe,transparent:!0,opacity:o.opacity}))}))},v=(e="",t=[])=>t.filter((t=>e.indexOf(t)>-1)).length>0;return{progress:r,MODEL_MAP:i,loadModel:h,loadModels:(t,s,l)=>T(void 0,void 0,void 0,(function*(){var c,u,f;yield R((null===(c=n.indexDB)||void 0===c?void 0:c.tbName)||I.indexdb.tbName,(null===(u=n.indexDB)||void 0===u?void 0:u.dbName)||I.indexdb.dbName,(null===(f=n.indexDB)||void 0===f?void 0:f.version)||I.indexdb.version).then((t=>(t&&(e.Cache.enabled=!0,o=t),t)));const g=t.length;if(!(0==g?(r.isEnd=!0,r.show=!1,0):(r.isEnd=!1,r.percentage=0,r.show=!0,1)))return;(e=>{for(let t=0;t<e.length;t++)r.total+=(e[t].size||0)*n.modelSizeKB})(t);let v=0;const w=()=>T(void 0,void 0,void 0,(function*(){const o=t[v],{type:c=i.device,size:u=0}=o;switch(c){case i.device:case i.pipe:yield h(o,l);break;case i.sprite:(t=>{const{key:o,range:r={x:1,y:1},mapUrl:i=""}=t;let s=(new e.TextureLoader).load(n.baseUrl+i),l=new e.SpriteMaterial({map:s}),c=new e.Sprite(l),d=r.x,u=r.y;c.scale.set(d,u,1),c.name="sprite",a.set(o,c)})(o);break;case i.font:yield((e,t)=>{const{url:o="",size:r=0}=e,{baseUrl:s}=n,l=E(o,s),c=new A;return new Promise(((e,o)=>T(void 0,void 0,void 0,(function*(){const n=yield p(l,r);if(n){const t=c.parse(JSON.parse(n));return a.set(i.font,t),void setTimeout((()=>{e(t)}),10)}c.load(l,(t=>{a.set(i.font,t),m(l),e(t)}),(e=>{d(e),"function"==typeof t&&t(e)}),o)}))))})(o,l);break;case i.warning:o.key=i.warning,yield h(o,l);break;case i.local:o.key=i.local,yield h(o,l);break;case i.disabled:o.key=i.disabled,yield h(o,l);break;case i.spotlight:(t=>{const{key:o,color:n=16777215,intensity:r=8,distance:i=10,angle:s=.2*Math.PI,penumbra:l=.2,decay:c=0}=t;let d=new e.SpotLight(n,r,i,s,l,c);d.castShadow=!0,d.visible=!1,a.set(o,d)})(o)}v++,r.loaded+=u*n.modelSizeKB,v>=g?(r.percentage=100,r.isEnd=!0,s()):w()}));w()})),getModel:e=>a.get(e),virtualization:(e=[],t,o={})=>{const n=o.filter||[],r=o.filterMatch||[];if(e.length)for(let i=0;i<e.length;i++){const a=e[i];t.uuid===a.uuid||n.includes(a.name)||v(a.name,r)||g(a,o)}else g(t,o)},closeVirtualization:e=>{if(Array.isArray(e))for(let t=0;t<e.length;t++)e[t].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}}});const{createCruise:de,cruiseAnimate:ue,updateCruise:pe,bindEvent:me,removeEvent:he}=ie(),{createFork:fe}=ae();class ge{constructor(t={}){se.add(this);const o=te;this.options=$(o,t),ge.total++,this.pointer={tsp:0,isClick:!1},Z(this.options.container)?this.container=this.options.container:this.container=document.querySelector(this.options.container),this.options.width=this.container.offsetWidth,this.options.height=this.container.offsetHeight,this.scene=new e.Scene,this.renderer=this.initRenderer(),this.baseCamera=this.initCamera(),this.controls=this.initControls(),this.init(),this.initCruise(),console.log(this)}get camera(){const{visible:e,runing:t,auto:o}=this.options.cruise;return e&&this.cruiseCamera&&t?this.cruiseCamera:this.baseCamera}init(){this.initLight(),this.initGrid(),this.initAxes(),this.initModel()}run(){this.loop()}loop(){this.animationId=window.requestAnimationFrame((()=>{this.loop()})),this.animate(),this.modelAnimate()}animate(){var e;this.renderer&&this.renderer.render(this.scene,this.camera),this.options.controls.visible&&(null===(e=this.controls)||void 0===e||e.update()),ue(this.cruiseCamera),t.update()}initModel(){}modelAnimate(){}initRenderer(){const{width:t,height:o,bgColor:n,bgUrl:r,env:i}=this.options,a=new e.WebGLRenderer(this.options.render);if(i&&this.setEnvironment(i),r?this.setBgTexture(r):this.setBgColor(n),this.options.fog.visible){const{color:t,near:o,far:n}=this.options.fog;this.scene.fog=new e.Fog(null!=t?t:this.scene.background,o,n)}return a.sortObjects=!0,a.shadowMap.enabled=!0,a.shadowMap.type=e.PCFSoftShadowMap,a.setSize(t,o),a.setPixelRatio(window.devicePixelRatio),this.container.appendChild(a.domElement),a}initLight(){const{ambientLight:t,directionalLight:o}=this.options;if(t.visible){const o=new e.AmbientLight(t.color,t.intensity);this.addObject(o)}if(o.visible){const t=this.createDirectionalLight(),[n=0,r=0,i=0]=o.position;if(t.position.set(n,r,i),this.addObject(t),o.helper){const o=new e.DirectionalLightHelper(t,1);this.addObject(o)}if(o.light2){const t=this.createDirectionalLight(!1),[n=0,r=0,i=0]=o.position2;if(t.position.set(n,r,i),this.addObject(t),o.helper){const o=new e.DirectionalLightHelper(t,1);this.addObject(o)}}}}createDirectionalLight(t=!0,o=2e3,n=4096,r=1,i=2e4){const{color:a,intensity:s}=this.options.directionalLight,l=new e.DirectionalLight(a,s);if(t){l.shadow.mapSize.setScalar(n),l.shadow.bias=-1e-5,l.shadow.normalBias=.01,l.castShadow=t;const e=l.shadow.camera;e.near=r,e.far=i,e.top=e.right=o,e.left=e.bottom=-o,e.updateProjectionMatrix()}return l}initCamera(){const{width:t,height:o,camera:n}=this.options;let r=new e.PerspectiveCamera(36,t/o,n.near,n.far);if(n.orthogonal){let i=t/o,a=260;r=new e.OrthographicCamera(-a*i,a*i,a,-a,n.near,n.far)}if(r.position.set(...n.position),r.lookAt(0,0,0),n.helper){const t=new e.CameraHelper(r);this.addObject(t)}return r}initControls(){const e=this.options.controls;if(!e.visible)return;const t=new o(this.camera,this.renderer.domElement);return Object.keys(e).forEach((o=>{t[o]=e[o]})),t.target.set(0,0,0),t.saveState(),t}initCruise(){const{visible:e}=this.options.cruise;e&&(this.cruiseCamera=this.initCamera(),function(e,t,o,n){if("a"===o&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===o?n:"a"===o?n.call(e):n?n.value:t.get(e)}(this,se,"m",le).call(this))}initGrid(){const t=this.options.grid;if(!t.visible)return;const{width:o,divisions:n,centerLineColor:r,gridColor:i,opacity:a,transparent:s,fork:l}=t,c=new e.GridHelper(o,n,r,i);if(c.material.opacity=a,c.material.transparent=s,this.grid=c,this.addObject(c),l){const e=fe(t);e.name="辅助交叉点",e._isGridFork_=!0,this.addObject(e)}}initAxes(){if(!this.options.axes.visible)return;const t=new e.AxesHelper(this.options.axes.size);this.addObject(t)}createGround(t=5e3,o,n=11721691){o=void 0===o?t:o;const r=new e.PlaneGeometry(t,o),i=new e.MeshPhongMaterial({color:n,shininess:10}),a=new e.Mesh(r,i);return a.name="ground",a.rotation.x=1.5*Math.PI,a.receiveShadow=!0,a}createClock(){this.clock=new e.Clock}setCruisePoint(e){this.options.cruise.points=e,this.createCruise()}createCruise(){const{visible:e,points:t,alway:o}=this.options.cruise;if(!e)return;if(this.cruiseGroup&&this.disposeObj(this.cruiseGroup),me(),!t||0==t.length)return;const n=de(this.options.cruise,this.renderer);this.cruiseGroup=n,n.visible=o,this.addObject(n)}toggleCruise(e){let{visible:t,runing:o,auto:n,alway:r}=this.options.cruise;t&&(o=null!=e?e:o,this.options.cruise.runing=!o,this.options.cruise.enabled=!o,this.controls&&(this.controls.enabled=n||o),this.cruiseGroup&&!r&&(this.cruiseGroup.visible=!o),pe(this.options.cruise))}toggleCruiseDepthTest(e){this.cruiseGroup&&this.cruiseGroup.traverse((t=>{(t.isMesh||t.isLine)&&(t.material.depthTest=null!=e?e:!t.material.depthTest)}))}setScale(e){this.options.scale=e}setEnvironment(t){(new n).load(E(t,this.options.baseUrl),(t=>{t.mapping=e.EquirectangularReflectionMapping,this.scene.environment=t}))}setBgTexture(t){if(Array.isArray(t)){const o=(new e.CubeTextureLoader).load(E(t,this.options.baseUrl));this.scene.background=o}else this.scene.background=(new e.TextureLoader).load(E(t))}setBgColor(t){this.scene.background=t?new e.Color(t):null}bindEvent(){const e=this.renderer.domElement;e.addEventListener("dblclick",this.onDblclick.bind(this)),e.addEventListener("pointerdown",this.onPointerDown.bind(this)),e.addEventListener("pointermove",this.onPointerMove.bind(this)),e.addEventListener("pointerup",this.onPointerUp.bind(this))}onDblclick(e){}onPointerDown(e){this.pointer.isClick=!0,this.pointer.tsp=e.timeStamp}onPointerMove(e){}onPointerUp(e){this.pointer.isClick=!1}exportImage(){const e=document.createElement("a");e.download="render.png",e.href=this.renderer.domElement.toDataURL().replace("image/png","image/octet-stream"),e.click()}getPosition(){var e,t;return console.log("camera.position",this.camera.position),console.log("controls.target",null===(e=this.controls)||void 0===e?void 0:e.target),{position:this.camera.position,target:null===(t=this.controls)||void 0===t?void 0:t.target}}isCameraMove(e,t=1){const o=this.camera.position;return Math.abs(o.x-e.x)<t&&Math.abs(o.y-e.y)<t&&Math.abs(o.z-e.z)<t}addObject(...e){this.scene.add(...e)}controlSave(){var e;null===(e=this.controls)||void 0===e||e.saveState()}controlReset(){var e;null===(e=this.controls)||void 0===e||e.reset(),this.toggleCruise(!0)}getValidTargetPosition(e,t,o,n={x:-104,y:7,z:58}){const r=t||e.to||n,i=o||e.target||{x:0,y:0,z:0},a=this.controls;return a&&a.target&&a.target.set(i.x,i.y,i.z),r}resize(){this.options.width=this.container.offsetWidth||window.innerWidth,this.options.height=this.container.offsetHeight||window.innerHeight;const{width:e,height:t,camera:o}=this.options,n=e/t;o.orthogonal||(this.baseCamera.aspect=n),this.baseCamera.updateProjectionMatrix(),this.cruiseCamera&&(o.orthogonal||(this.cruiseCamera.aspect=n),this.cruiseCamera.updateProjectionMatrix()),this.renderer.setSize(e,t)}stopAnimate(){window.cancelAnimationFrame(this.animationId)}clear(e){e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())}disposeObj(e){e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear(),this.scene.remove(e))}dispose(){var t;he(),this.stopAnimate();try{e.Cache.clear(),this.disposeObj(this.scene),this.scene.clear(),this.renderer.dispose(),this.renderer.forceContextLoss();let o=this.renderer.domElement.getContext("webgl");o&&(null===(t=o.getExtension("WEBGL_lose_context"))||void 0===t||t.loseContext()),this.disposeObj(this.cruiseGroup),this.disposeObj(this.grid),this.controls&&this.controls.dispose(),this.scene=void 0,this.renderer=void 0,this.baseCamera=void 0,this.cruiseCamera=void 0,this.controls=void 0,this.grid=void 0,this.cruiseGroup=void 0,this.container.innerHTML=""}catch(e){console.log(e)}}}se=new WeakSet,le=function(){const e=this.options.cruise;e.enabled=!1,e.runing=!1,e.baseUrl&&(e.baseUrl=this.options.baseUrl),e.factor=1},ge.total=0;export{ce as Hook,ge as Scene,ee as Util};
